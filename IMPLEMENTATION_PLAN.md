# å¤šè‚¡ç¥¨çµ„åˆè©•ä¼°èˆ‡ Niching ç­–ç•¥å¯¦ä½œè¨ˆç•«

**ç‰ˆæœ¬**: 1.4  
**æ—¥æœŸ**: 2025-10-13  
**ç‹€æ…‹**: Phase 1 å®Œæˆï¼ŒPhase 2.0 å®Œæˆï¼ŒPhase 2.1 å®Œæˆï¼ŒPhase 2.1.5 (Early Stopping) å®Œæˆ  
**é ä¼°æ™‚ç¨‹**: 4-6 é€±

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#å°ˆæ¡ˆæ¦‚è¿°)
2. [éœ€æ±‚åˆ†æ](#éœ€æ±‚åˆ†æ)
3. [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
4. [å¯¦ä½œæ–¹æ¡ˆ Aï¼šä¿å®ˆæ¼¸é€²å¼](#å¯¦ä½œæ–¹æ¡ˆ-aä¿å®ˆæ¼¸é€²å¼)
5. [è»Ÿé«”å·¥ç¨‹æº–å‰‡](#è»Ÿé«”å·¥ç¨‹æº–å‰‡)
6. [æ¸¬è©¦ç­–ç•¥](#æ¸¬è©¦ç­–ç•¥)
7. [é¢¨éšªç®¡ç†](#é¢¨éšªç®¡ç†)
8. [æœªä¾†æ“´å±•](#æœªä¾†æ“´å±•)
9. [æ™‚ç¨‹è¦åŠƒ](#æ™‚ç¨‹è¦åŠƒ)

---

## å°ˆæ¡ˆæ¦‚è¿°

### ç›®æ¨™

å¯¦ä½œå…©å€‹æ ¸å¿ƒåŠŸèƒ½ä»¥æå‡ GP äº¤æ˜“ç­–ç•¥æ¼”åŒ–ç³»çµ±ï¼š

1. **å¤šè‚¡ç¥¨çµ„åˆè©•ä¼°**: æ¼”åŒ–å‡ºèƒ½é©ç”¨æ–¼å¤šæª”è‚¡ç¥¨çš„é€šç”¨ç­–ç•¥
2. **Niching ç­–ç•¥**: ä½¿ç”¨æ¨¹çµæ§‹ç›¸ä¼¼åº¦ç¶­æŒæ—ç¾¤å¤šæ¨£æ€§

### å‹•æ©Ÿ

- **é€šç”¨æ€§**: é¿å…ç­–ç•¥éåº¦æ“¬åˆå–®ä¸€è‚¡ç¥¨
- **ç©©å¥æ€§**: æå‡ç­–ç•¥åœ¨ä¸åŒå¸‚å ´ç’°å¢ƒçš„é©æ‡‰æ€§
- **å¤šæ¨£æ€§**: é˜²æ­¢æ—ç¾¤éæ—©æ”¶æ–‚ï¼Œæ¢ç´¢æ›´å»£çš„è§£ç©ºé–“

### æˆåŠŸæŒ‡æ¨™

- [ ] çµ„åˆè©•ä¼°çš„ç­–ç•¥åœ¨æ¸¬è©¦é›†ä¸Šè¡¨ç¾å„ªæ–¼å–®è‚¡ç¥¨ç­–ç•¥ï¼ˆæ›´ç©©å¥ ex: sharpe ratioï¼‰
- [ ] Niching ç­–ç•¥é¡¯è‘—æå‡æ—ç¾¤çµæ§‹å¤šæ¨£æ€§
- [ ] æ¼”åŒ–éç¨‹ä¸­ç¶­æŒè¼ƒé«˜çš„ genotypic diversity
- [ ] Niching èƒ½å¤ åœ¨æ¸¬è©¦é›†ä¸Šè¡¨ç¾å„ªæ–¼ç„¡ Niching çš„ç­–ç•¥

---

## éœ€æ±‚åˆ†æ

### éœ€æ±‚ 1: å¤šè‚¡ç¥¨çµ„åˆè©•ä¼°

#### åŠŸèƒ½éœ€æ±‚

**FR1.1 çµ„åˆå›æ¸¬å¼•æ“**
- å–®ä¸€å€‹é«”åœ¨ k æª”è‚¡ç¥¨ä¸ŠåŒæ™‚åŸ·è¡Œ
- æ¯æª”è‚¡ç¥¨ç¨ç«‹ç”¢ç”Ÿäº¤æ˜“è¨Šè™Ÿ
- äº‹ä»¶é©…å‹•çš„è³‡é‡‘å†å¹³è¡¡æ©Ÿåˆ¶

**FR1.2 è³‡é‡‘ç®¡ç†**
- åˆå§‹è³‡é‡‘ç­‰åˆ†é…åˆ° k æª”è‚¡ç¥¨
- ç•¶æŸè‚¡ç¥¨ç”¢ç”Ÿè²·å…¥è¨Šè™Ÿæ™‚ï¼Œä½¿ç”¨è©²è‚¡ç¥¨çš„å¯ç”¨è³‡é‡‘
- ç•¶æŸè‚¡ç¥¨ç”¢ç”Ÿè³£å‡ºè¨Šè™Ÿæ™‚ï¼Œè³‡é‡‘å›åˆ°è©²è‚¡ç¥¨æ± 
- è³‡é‡‘åœ¨è‚¡ç¥¨é–“ç¨ç«‹é‹ä½œï¼Œä¸äº’ç›¸æŒªç”¨

**FR1.3 çµ„åˆç¸¾æ•ˆè¨ˆç®—**
- è¨ˆç®—æ¯æª”è‚¡ç¥¨çš„ PnL
- è¨ˆç®—çµ„åˆç¸½ PnL = Î£(PnL_i)
- è¨ˆç®—çµ„åˆ Sharpe Ratio, Max Drawdown ç­‰æŒ‡æ¨™
- Fitness = å¯é…ç½®é¸æ“‡ï¼š
  - `excess_return`: çµ„åˆçš„ Excess Returnï¼ˆåŸè«–æ–‡æ–¹æ³•ï¼‰
  - `sharpe_ratio`: çµ„åˆçš„ Sharpe Ratioï¼ˆé¢¨éšªèª¿æ•´å›å ±ï¼‰
  - `avg_sharpe`: å„è‚¡ç¥¨ Sharpe Ratio çš„å¹³å‡å€¼

**FR1.4 å‘å¾Œå…¼å®¹**
- ä¿ç•™å–®è‚¡ç¥¨è©•ä¼°æ¨¡å¼
- é€éåƒæ•¸åˆ‡æ›è©•ä¼°æ¨¡å¼

#### éåŠŸèƒ½éœ€æ±‚

**NFR1.1 æ•ˆèƒ½**
- æ”¯æ´å¹³è¡ŒåŒ–è©•ä¼°

**NFR1.2 å¯æ“´å±•æ€§**
- æ”¯æ´ k=1 åˆ° k=10 çš„è‚¡ç¥¨æ•¸é‡
- æ˜“æ–¼æ“´å±•åˆ°å…¶ä»–è³‡ç”¢é¡åˆ¥

**NFR1.3 å¯æ¸¬è©¦æ€§** [Optional]
- æ¯å€‹æ¨¡çµ„æœ‰ç¨ç«‹çš„å–®å…ƒæ¸¬è©¦
- æä¾›æ¸¬è©¦æ•¸æ“šå’ŒåŸºæº–çµæœ

---

### éœ€æ±‚ 2: Niching ç­–ç•¥

#### åŠŸèƒ½éœ€æ±‚

**FR2.1 Tree Edit Distance è¨ˆç®—**
- å¯¦ä½œ Tree Edit Distance (TED) æ¼”ç®—æ³•
- æ”¯æ´ GP tree çš„ç‰¹æ®Šç¯€é»é¡å‹ï¼ˆprimitives, terminalsï¼‰
- è¨ˆç®—æ•ˆç‡ï¼šO(nÂ²) æˆ–æ›´å„ª

**FR2.2 Tree Similarity Matrix**
- è¨ˆç®—æ—ç¾¤ä¸­æ‰€æœ‰å€‹é«”å…©å…©çš„ç›¸ä¼¼åº¦
- æ¨™æº–åŒ–ç‚º [0, 1] ç¯„åœ
- æ”¯æ´å¿«å–å’Œå¢é‡æ›´æ–°

**FR2.3 èšé¡æ©Ÿåˆ¶**
- åŸºæ–¼ç›¸ä¼¼åº¦çŸ©é™£é€²è¡Œèšé¡
- æ”¯æ´å¤šç¨®èšé¡æ¼”ç®—æ³•ï¼ˆK-means, Hierarchicalï¼‰
- ç¾¤æ•¸ M å…ˆä»¥å›ºå®šé–‹ç™¼ï¼Œå¾ŒçºŒä¿ç•™å‹•æ…‹çš„æ“´å……æ€§

**FR2.4 è·¨ç¾¤ Parent Selection**
- ä¿®æ”¹ selection operator
- å„ªå…ˆå¾ä¸åŒç¾¤ä¸­é¸æ“‡çˆ¶æ¯
- å¯é…ç½®è·¨ç¾¤äº¤é…æ¯”ä¾‹ï¼ˆå¦‚ 80% çš„ä¸‹ä¸€ä»£æ—ç¾¤ä¸€åœ°è¦ç”±è·¨ç¾¤è€Œä¾†ï¼Œå‰©ä¸‹çš„ 20% çµ„å…§è‡ªè¡Œäº¤é…ï¼‰

**FR2.5 Fitness Sharing (æœªä¾†åœ¨åšå…ˆä¸ç”¨)**
- åœ¨åŒä¸€ niche å…§é€²è¡Œ fitness sharing
- é™ä½ç›¸ä¼¼å€‹é«”çš„ fitness
- é¼“å‹µæ¢ç´¢ä¸åŒå€åŸŸ

#### éåŠŸèƒ½éœ€æ±‚

**NFR2.1 æ•ˆèƒ½**
- æ”¯æ´å¹³è¡ŒåŒ–è¨ˆç®—

**NFR2.2 å¯é…ç½®æ€§**
- æ‰€æœ‰ niching åƒæ•¸å¯é€éé…ç½®æª”èª¿æ•´
- æ”¯æ´å‹•æ…‹èª¿æ•´åƒæ•¸

**NFR2.3 å¯è¦–è¦ºåŒ–**
- ç›¸ä¼¼åº¦çŸ©é™£ç†±åœ–
- èšé¡çµæœè¦–è¦ºåŒ–
- Niche æ¼”åŒ–è¶¨å‹¢åœ–

---

## æŠ€è¡“æ¶æ§‹

### ç³»çµ±æ¶æ§‹åœ–

**æ–¹æ¡ˆ F: å®Œå…¨ä¸¦è¡ŒåŒ–æ¶æ§‹ï¼ˆæ”¯æ´ Population 500-5000ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Parallel Evolution Engine (8 processes)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Population Management                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                  â”‚                                      â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                â”‚          ä¸¦è¡ŒåŸ·è¡Œéšæ®µ               â”‚                    â”‚
â”‚                â”‚     ï¼ˆå¯åŒæ™‚åŸ·è¡Œæˆ–ç¨ç«‹åŸ·è¡Œï¼‰          â”‚                    â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                  â”‚                                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â–¼                                                 â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Fitness Evaluation  â”‚                    â”‚  Tree Similarity     â”‚   â”‚
â”‚  â”‚   (ä¸¦è¡ŒåŒ– 8 cores)    â”‚                    â”‚  Calculation         â”‚   â”‚
â”‚  â”‚                      â”‚                    â”‚  (ä¸¦è¡ŒåŒ– 8 cores)     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚                      â”‚   â”‚
â”‚  â”‚  â”‚ Process Pool   â”‚  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ - Worker 1-8   â”‚  â”‚                    â”‚  â”‚ Process Pool   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - Portfolio    â”‚  â”‚                    â”‚  â”‚ - Worker 1-8   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚   Backtest     â”‚  â”‚                    â”‚  â”‚ - TED Compute  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ - 4 stocks     â”‚  â”‚                    â”‚  â”‚ - Pair-wise    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                      â”‚                    â”‚                      â”‚   â”‚
â”‚  â”‚  æ™‚é–“: ~550s          â”‚                    â”‚  æ™‚é–“: ~860s         â”‚  â”‚
â”‚  â”‚  (n=5000)            â”‚                    â”‚  (n=5000)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                 â”‚             â”‚
â”‚         â”‚                                                 â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â–¼                                              â”‚
â”‚                   [åŒæ­¥é» Sync Point]                                   â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚  Fitness Scores        â”‚                                 â”‚
â”‚              â”‚  Similarity Matrix     â”‚                                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚     Clustering         â”‚                                 â”‚
â”‚              â”‚   (K-means/Hierarchical)â”‚                                â”‚
â”‚              â”‚   æ™‚é–“: ~50s            â”‚                                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚  Two-Stage Selection   â”‚                                 â”‚
â”‚              â”‚                        â”‚                                 â”‚
â”‚              â”‚  Stage 1: Within-Niche â”‚                                 â”‚
â”‚              â”‚    Tournament (size=3) â”‚                                 â”‚
â”‚              â”‚                        â”‚                                 â”‚
â”‚              â”‚  Stage 2: Cross-Niche  â”‚                                 â”‚
â”‚              â”‚    Pairing (80% cross) â”‚                                 â”‚
â”‚              â”‚                        â”‚                                 â”‚
â”‚              â”‚  æ™‚é–“: ~10s             â”‚                                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚  Crossover & Mutation  â”‚                                 â”‚
â”‚              â”‚  (DEAP operators)      â”‚                                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚   New Population       â”‚                                 â”‚
â”‚              â”‚   (n=5000)             â”‚                                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸ·è¡Œæ¨¡å¼ï¼š
  æ¨¡å¼ 1 (åºåˆ—): Fitness â†’ Similarity â†’ Clustering â†’ Selection
           æ™‚é–“: 550s + 860s + 50s + 10s = 1470s â‰ˆ 24.5 åˆ†é˜
  
  æ¨¡å¼ 2 (ä¸¦è¡Œ): max(Fitness, Similarity) â†’ Clustering â†’ Selection
           æ™‚é–“: max(550s, 860s) + 50s + 10s = 920s â‰ˆ 15.3 åˆ†é˜
           
  æ¨è–¦: æ¨¡å¼ 2 (ç¯€çœ 37% æ™‚é–“)
```

### æ¨¡çµ„è¨­è¨ˆ

#### 1. Portfolio Backtesting Engine

```
gp_quant/backtesting/
â”œâ”€â”€ engine.py                      # ç¾æœ‰çš„ BacktestingEngine
â”œâ”€â”€ portfolio_engine.py            # æ–°å¢ï¼šPortfolioBacktestingEngine
â”œâ”€â”€ rebalancing.py                 # æ–°å¢ï¼šå†å¹³è¡¡ç­–ç•¥
â””â”€â”€ metrics.py                     # æ–°å¢ï¼šçµ„åˆç¸¾æ•ˆæŒ‡æ¨™
```

**æ ¸å¿ƒé¡åˆ¥**:
- `PortfolioBacktestingEngine`: å¤šè‚¡ç¥¨çµ„åˆå›æ¸¬
- `EventDrivenRebalancer`: äº‹ä»¶é©…å‹•å†å¹³è¡¡
- `PortfolioMetrics`: çµ„åˆç¸¾æ•ˆè¨ˆç®—

#### 2. Tree Similarity Module

```
gp_quant/similarity/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ tree_edit_distance.py          # TED æ¼”ç®—æ³•å¯¦ä½œ
â”œâ”€â”€ similarity_matrix.py           # ç›¸ä¼¼åº¦çŸ©é™£è¨ˆç®—
â”œâ”€â”€ parallel_calculator.py         # æ–°å¢ï¼šä¸¦è¡Œè¨ˆç®—å™¨
â””â”€â”€ cache.py                       # å¿«å–æ©Ÿåˆ¶
```

**æ ¸å¿ƒé¡åˆ¥**:
- `TreeEditDistance`: TED è¨ˆç®—å™¨
- `SimilarityMatrix`: ç›¸ä¼¼åº¦çŸ©é™£ç®¡ç†
- `ParallelSimilarityCalculator`: ä¸¦è¡Œç›¸ä¼¼åº¦è¨ˆç®— â­ æ–°å¢
- `SimilarityCache`: å¿«å–ç®¡ç†

#### 3. Niching Strategy Module

```
gp_quant/niching/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ clustering.py                  # èšé¡æ¼”ç®—æ³•
â”œâ”€â”€ selection.py                   # è·¨ç¾¤é¸æ“‡
â”œâ”€â”€ fitness_sharing.py             # Fitness sharing (å¯é¸)
â””â”€â”€ visualizer.py                  # è¦–è¦ºåŒ–å·¥å…·
```

**æ ¸å¿ƒé¡åˆ¥**:
- `NichingClusterer`: èšé¡ç®¡ç†
- `CrossNicheSelector`: è·¨ç¾¤é¸æ“‡å™¨
- `FitnessSharing`: Fitness sharing æ©Ÿåˆ¶

#### 4. Parallel Execution Module â­ æ–°å¢

```
gp_quant/parallel/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ executor.py                    # ä¸¦è¡ŒåŸ·è¡Œå™¨
â”œâ”€â”€ fitness_evaluator.py           # ä¸¦è¡Œ fitness è©•ä¼°
â””â”€â”€ sync.py                        # åŒæ­¥æ©Ÿåˆ¶
```

**æ ¸å¿ƒé¡åˆ¥**:
- `ParallelExecutor`: ä¸¦è¡ŒåŸ·è¡Œç®¡ç†å™¨
- `ParallelFitnessEvaluator`: ä¸¦è¡Œ fitness è©•ä¼°å™¨
- `SyncPoint`: åŒæ­¥é»ç®¡ç†

#### 5. Evolution Engine æ•´åˆ

```
gp_quant/evolution/
â”œâ”€â”€ engine.py                      # ä¿®æ”¹ï¼šæ•´åˆæ–°åŠŸèƒ½
â””â”€â”€ config.py                      # ä¿®æ”¹ï¼šæ–°å¢é…ç½®é¸é …
```

---

## å¯¦ä½œæ–¹æ¡ˆ Aï¼šä¿å®ˆæ¼¸é€²å¼

### Phase 1: å¤šè‚¡ç¥¨çµ„åˆè©•ä¼°åŸºç¤å»ºè¨­

**åˆ†æ”¯**: `feature/portfolio-evaluation`  
**é ä¼°æ™‚é–“**: 1.5-2 é€±

#### 1.1 Portfolio Backtesting Engine (Week 1) âœ… å·²å®Œæˆ

**ä»»å‹™æ¸…å–®**:
- [x] å‰µå»º `PortfolioBacktestingEngine` é¡åˆ¥
  - [x] åˆå§‹åŒ–ï¼šæ¥æ”¶å¤šæª”è‚¡ç¥¨æ•¸æ“š
  - [x] è³‡é‡‘åˆ†é…ï¼šç­‰åˆ†åˆå§‹è³‡é‡‘
  - [x] äº‹ä»¶é©…å‹•å›æ¸¬é‚è¼¯
- [x] å¯¦ä½œ `EventDrivenRebalancer`
  - [x] è¿½è¹¤æ¯æª”è‚¡ç¥¨çš„è³‡é‡‘ç‹€æ…‹
  - [x] è™•ç†è²·å…¥/è³£å‡ºäº‹ä»¶
  - [x] è¨˜éŒ„äº¤æ˜“æ­·å²
- [x] å¯¦ä½œ `PortfolioMetrics`
  - [x] çµ„åˆ PnL è¨ˆç®—
  - [x] Sharpe Ratio
  - [x] Max Drawdown
  - [x] å€‹åˆ¥è‚¡ç¥¨è²¢ç»åº¦

**äº¤ä»˜ç‰©**:
- âœ… `gp_quant/backtesting/portfolio_engine.py`
- âœ… `gp_quant/backtesting/rebalancing.py`
- âœ… `gp_quant/backtesting/metrics.py`
- âš ï¸ å–®å…ƒæ¸¬è©¦ï¼ˆå¾…è£œå……ï¼‰

**é©—æ”¶æ¨™æº–**:
- [x] èƒ½æ­£ç¢ºè™•ç† k=4 çš„çµ„åˆå›æ¸¬
- [x] è³‡é‡‘åˆ†é…é‚è¼¯æ­£ç¢ºï¼ˆç„¡è² æ•¸ã€ç„¡è¶…é¡ï¼‰
- [x] ç¸¾æ•ˆæŒ‡æ¨™è¨ˆç®—æº–ç¢º
- [ ] é€šéæ‰€æœ‰å–®å…ƒæ¸¬è©¦ï¼ˆå¾…è£œå……ï¼‰

#### 1.2 ä¸¦è¡Œ Fitness è©•ä¼° â­ æ ¸å¿ƒ (Week 2) âœ… å·²å®Œæˆ

**ä»»å‹™æ¸…å–®**:
- [x] å¯¦ä½œ `ParallelFitnessEvaluator` é¡åˆ¥
  - [x] ä½¿ç”¨ multiprocessing.Pool (8 workers)
  - [x] æ‰¹æ¬¡åˆ†é…å€‹é«”åˆ°å„ worker
  - [x] æ¯å€‹ worker åŸ·è¡Œ portfolio backtest
  - [x] æ”¶é›†ä¸¦åˆä½µ fitness scores
- [x] ä¿®æ”¹ `EvolutionEngine.evaluate_population()`
  - [x] æ”¯æ´ portfolio mode åƒæ•¸
  - [x] èª¿ç”¨ `ParallelFitnessEvaluator`
  - [x] è¨ˆç®—çµ„åˆ fitness
  - [x] æ”¯æ´åºåˆ—æ¨¡å¼ï¼ˆç”¨æ–¼ debugï¼‰
- [x] å‘å¾Œå…¼å®¹è™•ç†
  - [x] ä¿ç•™å–®è‚¡ç¥¨æ¨¡å¼
  - [x] é…ç½®æª”åˆ‡æ›ï¼ˆparallel vs sequentialï¼‰
- [x] å¯¦ä½œç¯„ä¾‹è…³æœ¬
  - [x] æ¯”è¼ƒå–®è‚¡ç¥¨ vs çµ„åˆè©•ä¼°
  - [x] æ¯”è¼ƒåºåˆ— vs ä¸¦è¡ŒåŸ·è¡Œ

**äº¤ä»˜ç‰©**:
- âœ… `gp_quant/parallel/fitness_evaluator.py`
- âœ… `gp_quant/parallel/executor.py`
- âœ… ä¿®æ”¹å¾Œçš„ `gp_quant/evolution/engine.py`
- âœ… é…ç½®æª”ç¯„ä¾‹
- âœ… ç¯„ä¾‹è…³æœ¬ï¼ˆå¤šå€‹å¯¦é©—è…³æœ¬ï¼‰
- âš ï¸ æ•´åˆæ¸¬è©¦ï¼ˆå¾…è£œå……ï¼‰
- âš ï¸ æ€§èƒ½æ¸¬è©¦å ±å‘Šï¼ˆå¾…è£œå……ï¼‰

**é©—æ”¶æ¨™æº–**:
- [x] å–®è‚¡ç¥¨æ¨¡å¼ä»æ­£å¸¸é‹ä½œ
- [x] çµ„åˆæ¨¡å¼æ­£ç¢ºè¨ˆç®— fitness
- [x] ä¸¦è¡Œæ¨¡å¼åŠ é€Ÿæ¯” > 6x
- [x] Population=500 æ™‚ fitness è©•ä¼° < 1 åˆ†é˜
- [ ] Population=5000 æ™‚ fitness è©•ä¼° < 10 åˆ†é˜ï¼ˆå¾…é©—è­‰ï¼‰
- [x] é…ç½®åˆ‡æ›ç„¡èª¤
- [x] ç¯„ä¾‹è…³æœ¬å¯åŸ·è¡Œ

#### 1.3 æ¸¬è©¦èˆ‡æ–‡æª” (Week 2) ğŸ”„ éƒ¨åˆ†å®Œæˆ

**ä»»å‹™æ¸…å–®**:
- [ ] å®Œæ•´æ¸¬è©¦å¥—ä»¶
  - [ ] å–®å…ƒæ¸¬è©¦ï¼ˆå¾…è£œå……ï¼‰
  - [ ] æ•´åˆæ¸¬è©¦ï¼ˆå¾…è£œå……ï¼‰
  - [ ] å›æ­¸æ¸¬è©¦ï¼ˆç¢ºä¿ä¸ç ´å£ç¾æœ‰åŠŸèƒ½ï¼‰
- [ ] æ€§èƒ½æ¸¬è©¦
  - [ ] æ¸¬é‡å›æ¸¬æ™‚é–“ï¼ˆå¾…è£œå……ï¼‰
  - [ ] è¨˜æ†¶é«”ä½¿ç”¨ï¼ˆå¾…è£œå……ï¼‰
- [x] æ–‡æª”æ’°å¯«
  - [x] API æ–‡æª”
  - [x] ä½¿ç”¨æŒ‡å—
  - [x] è¨­è¨ˆæ–‡æª”

**äº¤ä»˜ç‰©**:
- âš ï¸ æ¸¬è©¦å ±å‘Šï¼ˆå¾…è£œå……ï¼‰
- âš ï¸ æ€§èƒ½åŸºæº–ï¼ˆå¾…è£œå……ï¼‰
- âœ… `docs/portfolio_evaluation.md`
- âœ… `PORTFOLIO_EXPERIMENT_README.md`

**é©—æ”¶æ¨™æº–**:
- [ ] æ¸¬è©¦è¦†è“‹ç‡ > 85%ï¼ˆå¾…é”æˆï¼‰
- [ ] æ‰€æœ‰æ¸¬è©¦é€šéï¼ˆå¾…è£œå……ï¼‰
- [x] æ–‡æª”å®Œæ•´æ¸…æ™°

#### 1.4 Code Review & Merge â­ï¸ è·³éï¼ˆå–®äººé–‹ç™¼ï¼‰

**ä»»å‹™æ¸…å–®**:
- [x] å…§éƒ¨ code reviewï¼ˆè‡ªæˆ‘å¯©æŸ¥ï¼‰
- [x] ä¿®æ­£ review æ„è¦‹
- [x] æº–å‚™ merge requestï¼ˆå–®äººé–‹ç™¼ï¼Œç›´æ¥ commitï¼‰
- [x] Merge åˆ° master

**é©—æ”¶æ¨™æº–**:
- [x] Code review é€šéï¼ˆè‡ªæˆ‘å¯©æŸ¥ï¼‰
- [ ] CI/CD é€šéï¼ˆæœªè¨­ç½® CI/CDï¼‰
- [x] ç„¡è¡çª
- [x] æ–‡æª”æ›´æ–°

---

### Phase 2: Tree Similarity è¨ˆç®—æ¨¡çµ„ ğŸ”„ é€²è¡Œä¸­

**åˆ†æ”¯**: `feature/tree-similarity`ï¼ˆæˆ–ç›´æ¥åœ¨ masterï¼‰  
**é ä¼°æ™‚é–“**: 1.5-2 é€±  
**ç•¶å‰ç‹€æ…‹**: å°šæœªé–‹å§‹ï¼Œéœ€è¦å…ˆè£œå…… `Norm` operator

#### 2.0 è£œå……ç¼ºå¤±çš„ GP Operator (Week 3) ğŸ¯ ç•¶å‰ä»»å‹™

**ä»»å‹™æ¸…å–®**:
- [ ] å¯¦ä½œ `Norm(r1, r2)` operator
  - [ ] åœ¨ `gp_quant/gp/primitives.py` ä¸­å¯¦ä½œå‡½æ•¸
  - [ ] è¨ˆç®—å…©å€‹æ•¸å€¼å‘é‡å·®å€¼çš„çµ•å°å€¼ï¼š`|r1 - r2|`
  - [ ] è™•ç†å‘é‡åŒ–æ“ä½œ
  - [ ] æ·»åŠ éŒ¯èª¤ä¿è­·æ©Ÿåˆ¶
- [ ] è¨»å†Šåˆ° primitive set
  - [ ] åœ¨ `gp_quant/gp/operators.py` ä¸­è¨»å†Š
  - [ ] å®šç¾©é¡å‹ç°½åï¼š`[NumVector, NumVector] -> NumVector`
- [ ] æ¸¬è©¦æ–° operator
  - [ ] å–®å…ƒæ¸¬è©¦
  - [ ] æ•´åˆæ¸¬è©¦ï¼ˆç¢ºä¿ GP tree å¯ä»¥ä½¿ç”¨ï¼‰

**äº¤ä»˜ç‰©**:
- ä¿®æ”¹å¾Œçš„ `gp_quant/gp/primitives.py`
- ä¿®æ”¹å¾Œçš„ `gp_quant/gp/operators.py`
- å–®å…ƒæ¸¬è©¦

**é©—æ”¶æ¨™æº–**:
- [ ] `Norm` operator æ­£ç¢ºå¯¦ä½œ
- [ ] å¯ä»¥åœ¨ GP tree ä¸­ä½¿ç”¨
- [ ] é€šéå–®å…ƒæ¸¬è©¦

#### 2.1 Tree Edit Distance å¯¦ä½œ (Week 3-4) â³ å¾…é–‹å§‹

**ä»»å‹™æ¸…å–®**:
- [ ] ç ”ç©¶ TED æ¼”ç®—æ³•
  - [ ] APTED (All Path Tree Edit Distance)
  - [ ] RTED (Robust Tree Edit Distance)
  - [ ] é¸æ“‡é©åˆçš„æ¼”ç®—æ³•
- [ ] å¯¦ä½œ `TreeEditDistance` é¡åˆ¥
  - [ ] è™•ç† GP tree çµæ§‹
  - [ ] å®šç¾©ç·¨è¼¯æ“ä½œæˆæœ¬
  - [ ] è¨ˆç®—æœ€å°ç·¨è¼¯è·é›¢
- [ ] å„ªåŒ–æ•ˆèƒ½
  - [ ] å‹•æ…‹è¦åŠƒå„ªåŒ–
  - [ ] è¨˜æ†¶é«”å„ªåŒ–

**äº¤ä»˜ç‰©**:
- `gp_quant/similarity/tree_edit_distance.py`ï¼ˆæ–°å¢ç›®éŒ„ï¼‰
- æ¼”ç®—æ³•é¸æ“‡æ–‡æª”
- å–®å…ƒæ¸¬è©¦

**é©—æ”¶æ¨™æº–**:
- [ ] TED è¨ˆç®—æ­£ç¢º
- [ ] è™•ç†å„ç¨®æ¨¹çµæ§‹ï¼ˆé«˜åº¦ã€è¤‡é›œåº¦ï¼‰
- [ ] æ€§èƒ½å¯æ¥å—ï¼ˆ< 100ms per pairï¼‰

#### 2.2 ä¸¦è¡Œç›¸ä¼¼åº¦è¨ˆç®— â­ æ ¸å¿ƒ (Week 4-5) â³ å¾…é–‹å§‹

**ä»»å‹™æ¸…å–®**:
- [ ] å¯¦ä½œ `ParallelSimilarityCalculator` é¡åˆ¥
  - [ ] ä½¿ç”¨ multiprocessing.Pool (8 workers)
  - [ ] å°‡é…å°åˆ†é…åˆ°å„ worker
  - [ ] æ”¶é›†ä¸¦åˆä½µçµæœ
- [ ] å¯¦ä½œ `SimilarityMatrix` é¡åˆ¥
  - [ ] æ‰¹æ¬¡è¨ˆç®—ç›¸ä¼¼åº¦
  - [ ] æ¨™æº–åŒ–ç‚º [0, 1]
  - [ ] å°ç¨±çŸ©é™£å„ªåŒ–ï¼ˆåªè¨ˆç®—ä¸Šä¸‰è§’ï¼‰
- [ ] å¯¦ä½œå¿«å–æ©Ÿåˆ¶
  - [ ] å¿«å–å·²è¨ˆç®—çš„ç›¸ä¼¼åº¦
  - [ ] å¢é‡æ›´æ–°ç­–ç•¥ï¼ˆå¯é¸ï¼Œå¾ŒçºŒå„ªåŒ–ï¼‰
- [ ] æ•ˆèƒ½å„ªåŒ–
  - [ ] ä»»å‹™åˆ†é…ç­–ç•¥ï¼ˆå‡å‹»åˆ†é… vs å‹•æ…‹åˆ†é…ï¼‰
  - [ ] è¨˜æ†¶é«”ç®¡ç†ï¼ˆé¿å…è¤‡è£½å¤§é‡æ•¸æ“šï¼‰
  - [ ] é€²åº¦è¿½è¹¤

**äº¤ä»˜ç‰©**:
- `gp_quant/similarity/parallel_calculator.py` â­ æ–°å¢
- `gp_quant/similarity/similarity_matrix.py`
- `gp_quant/similarity/cache.py`
- æ€§èƒ½æ¸¬è©¦å ±å‘Šï¼ˆåŒ…å«ä¸åŒ population size çš„åŠ é€Ÿæ¯”ï¼‰

**é©—æ”¶æ¨™æº–**:
- [ ] Population=500 æ™‚è¨ˆç®—æ™‚é–“ < 10 ç§’ï¼ˆä¸¦è¡ŒåŒ–å¾Œï¼‰
- [ ] Population=5000 æ™‚è¨ˆç®—æ™‚é–“ < 15 åˆ†é˜ï¼ˆä¸¦è¡ŒåŒ–å¾Œï¼‰
- [ ] åŠ é€Ÿæ¯” > 6xï¼ˆ8 cores ç†è«– 8xï¼Œå¯¦éš› 6-7xï¼‰
- [ ] è¨˜æ†¶é«”ä½¿ç”¨åˆç†ï¼ˆ< 2GB for n=5000ï¼‰
- [ ] æ”¯æ´é€²åº¦é¡¯ç¤º

#### 2.3 è¦–è¦ºåŒ–å·¥å…· (Week 5) â³ å¾…é–‹å§‹

**ä»»å‹™æ¸…å–®**:
- [ ] ç›¸ä¼¼åº¦çŸ©é™£ç†±åœ–
- [ ] ç›¸ä¼¼åº¦åˆ†ä½ˆç›´æ–¹åœ–
- [ ] å€‹é«”ç›¸ä¼¼åº¦ç¶²çµ¡åœ–
- [ ] ç¯„ä¾‹è…³æœ¬

**äº¤ä»˜ç‰©**:
- `gp_quant/similarity/visualizer.py`
- `samples/similarity/sample_similarity_analysis.py`
- è¦–è¦ºåŒ–ç¯„ä¾‹åœ–

**é©—æ”¶æ¨™æº–**:
- [ ] åœ–è¡¨æ¸…æ™°æ˜“è®€
- [ ] æ”¯æ´å„²å­˜é«˜è§£æåº¦åœ–ç‰‡
- [ ] ç¯„ä¾‹è…³æœ¬å¯åŸ·è¡Œ

#### 2.4 æ¸¬è©¦èˆ‡æ–‡æª”

**ä»»å‹™æ¸…å–®**:
- [ ] å®Œæ•´æ¸¬è©¦å¥—ä»¶
- [ ] é‚Šç•Œæ¢ä»¶æ¸¬è©¦
- [ ] æ–‡æª”æ’°å¯«

**äº¤ä»˜ç‰©**:
- æ¸¬è©¦å ±å‘Š
- `docs/tree_similarity.md`

#### 2.5 Code Review & Merge

---

### Phase 3: Niching ç­–ç•¥å¯¦ä½œ â³ å¾…é–‹å§‹

**åˆ†æ”¯**: `feature/niching-strategy`ï¼ˆæˆ–ç›´æ¥åœ¨ masterï¼‰  
**é ä¼°æ™‚é–“**: 2-2.5 é€±  
**å‰ç½®æ¢ä»¶**: Phase 2 å®Œæˆ

#### 3.1 èšé¡æ¼”ç®—æ³•æ•´åˆ (Week 1)

**ä»»å‹™æ¸…å–®**:
- [ ] å¯¦ä½œ `NichingClusterer` é¡åˆ¥
  - [ ] K-means clustering
  - [ ] Hierarchical clustering
  - [ ] å‹•æ…‹ç¾¤æ•¸æ±ºå®šï¼ˆElbow method, Silhouetteï¼‰
- [ ] æ•´åˆ Tree Similarity Matrix
- [ ] èšé¡çµæœç®¡ç†
  - [ ] è¿½è¹¤æ¯å€‹å€‹é«”çš„ niche ID
  - [ ] è¨ˆç®— niche çµ±è¨ˆè³‡è¨Š

**äº¤ä»˜ç‰©**:
- `gp_quant/niching/clustering.py`
- èšé¡æ¼”ç®—æ³•æ¯”è¼ƒå ±å‘Š
- å–®å…ƒæ¸¬è©¦

**é©—æ”¶æ¨™æº–**:
- [ ] èšé¡çµæœç©©å®š
- [ ] æ”¯æ´å¤šç¨®æ¼”ç®—æ³•
- [ ] ç¾¤æ•¸é¸æ“‡åˆç†

#### 3.2 è·¨ç¾¤ Parent Selection (Week 1-2)

**ä»»å‹™æ¸…å–®**:
- [ ] å¯¦ä½œ `CrossNicheSelector` é¡åˆ¥
  - [ ] ä¿®æ”¹ DEAP selection operator
  - [ ] è·¨ç¾¤é¸æ“‡é‚è¼¯
  - [ ] å¯é…ç½®è·¨ç¾¤æ¯”ä¾‹
- [ ] æ•´åˆåˆ° `EvolutionEngine`
  - [ ] åœ¨ selection éšæ®µèª¿ç”¨
  - [ ] è¨˜éŒ„è·¨ç¾¤äº¤é…çµ±è¨ˆ
- [ ] ä¿ç•™ç¾¤å…§ç«¶çˆ­
  - [ ] Tournament selection within niche
  - [ ] Fitness ranking

**äº¤ä»˜ç‰©**:
- `gp_quant/niching/selection.py`
- ä¿®æ”¹å¾Œçš„ `gp_quant/evolution/engine.py`
- é¸æ“‡ç­–ç•¥æ–‡æª”

**é©—æ”¶æ¨™æº–**:
- [ ] è·¨ç¾¤äº¤é…æ¯”ä¾‹ç¬¦åˆè¨­å®š
- [ ] ä¸ç ´å£æ¼”åŒ–æ”¶æ–‚æ€§
- [ ] çµ±è¨ˆè³‡è¨Šæº–ç¢º

#### 3.3 Fitness Sharing (å¯é¸) (Week 2)

**ä»»å‹™æ¸…å–®**:
- [ ] å¯¦ä½œ `FitnessSharing` é¡åˆ¥
  - [ ] è¨ˆç®— sharing function
  - [ ] èª¿æ•´å€‹é«” fitness
- [ ] åƒæ•¸èª¿æ•´
  - [ ] Sharing radius
  - [ ] Sharing coefficient
- [ ] æ•ˆæœè©•ä¼°

**äº¤ä»˜ç‰©**:
- `gp_quant/niching/fitness_sharing.py`
- åƒæ•¸èª¿æ•´æŒ‡å—

**é©—æ”¶æ¨™æº–**:
- [ ] Fitness sharing æ­£ç¢ºå¯¦ä½œ
- [ ] åƒæ•¸å¯é…ç½®
- [ ] æœ‰æ•ˆæå‡å¤šæ¨£æ€§

#### 3.4 è¦–è¦ºåŒ–èˆ‡åˆ†æ (Week 2)

**ä»»å‹™æ¸…å–®**:
- [ ] Niche åˆ†ä½ˆè¦–è¦ºåŒ–
- [ ] Niche æ¼”åŒ–è¶¨å‹¢åœ–
- [ ] è·¨ç¾¤äº¤é…çµ±è¨ˆåœ–
- [ ] å¤šæ¨£æ€§æŒ‡æ¨™è¿½è¹¤

**äº¤ä»˜ç‰©**:
- `gp_quant/niching/visualizer.py`
- `samples/niching/sample_niching_analysis.py`

**é©—æ”¶æ¨™æº–**:
- [ ] åœ–è¡¨æ¸…æ™°å±•ç¤º niching æ•ˆæœ
- [ ] æ”¯æ´å¤šç¨®è¦–è¦ºåŒ–æ–¹å¼

#### 3.5 æ¸¬è©¦èˆ‡æ–‡æª”

**ä»»å‹™æ¸…å–®**:
- [ ] å®Œæ•´æ¸¬è©¦å¥—ä»¶
- [ ] èˆ‡ baseline æ¯”è¼ƒå¯¦é©—
- [ ] æ–‡æª”æ’°å¯«

**äº¤ä»˜ç‰©**:
- æ¸¬è©¦å ±å‘Š
- æ¯”è¼ƒå¯¦é©—çµæœ
- `docs/niching_strategy.md`

#### 3.6 Code Review & Merge

---

### Phase 4: æ•´åˆå¯¦é©—èˆ‡åˆ†æ â³ å¾…é–‹å§‹

**åˆ†æ”¯**: `feature/integrated-experiments`ï¼ˆæˆ–ç›´æ¥åœ¨ masterï¼‰  
**é ä¼°æ™‚é–“**: 1-1.5 é€±  
**å‰ç½®æ¢ä»¶**: Phase 3 å®Œæˆ

#### 4.1 å®Œæ•´å¯¦é©—æµç¨‹ (Week 1)

**ä»»å‹™æ¸…å–®**:
- [ ] è¨­è¨ˆå¯¦é©—é…ç½®
  - [ ] Baseline: å–®è‚¡ç¥¨ + ç„¡ niching
  - [ ] Exp1: çµ„åˆè©•ä¼° + ç„¡ niching
  - [ ] Exp2: å–®è‚¡ç¥¨ + niching
  - [ ] Exp3: çµ„åˆè©•ä¼° + niching
- [ ] å¯¦ä½œå¯¦é©—è…³æœ¬
  - [ ] `experiments/portfolio_niching_experiments.py`
  - [ ] æ‰¹æ¬¡åŸ·è¡Œ
  - [ ] çµæœæ”¶é›†
- [ ] å¤šçµ„åƒæ•¸æ¸¬è©¦
  - [ ] ä¸åŒè‚¡ç¥¨çµ„åˆ
  - [ ] ä¸åŒ niche æ•¸é‡
  - [ ] ä¸åŒè·¨ç¾¤æ¯”ä¾‹

**äº¤ä»˜ç‰©**:
- å¯¦é©—è…³æœ¬
- å¯¦é©—é…ç½®æª”
- åˆæ­¥çµæœ

**é©—æ”¶æ¨™æº–**:
- [ ] å¯¦é©—å¯é‡ç¾
- [ ] çµæœè‡ªå‹•æ”¶é›†
- [ ] é…ç½®æ¸…æ™°

#### 4.2 çµæœåˆ†æå·¥å…· (Week 1)

**ä»»å‹™æ¸…å–®**:
- [ ] çµ„åˆç¸¾æ•ˆåˆ†æ
  - [ ] å„è‚¡ç¥¨è²¢ç»åº¦
  - [ ] çµ„åˆé¢¨éšªæŒ‡æ¨™
  - [ ] èˆ‡ baseline æ¯”è¼ƒ
- [ ] Niching æ•ˆæœåˆ†æ
  - [ ] å¤šæ¨£æ€§æŒ‡æ¨™è¶¨å‹¢
  - [ ] æ”¶æ–‚é€Ÿåº¦æ¯”è¼ƒ
  - [ ] Niche ç©©å®šæ€§
- [ ] çµ±è¨ˆé¡¯è‘—æ€§æª¢é©—
  - [ ] t-test
  - [ ] Wilcoxon test
- [ ] è¦–è¦ºåŒ–å ±å‘Šç”Ÿæˆ

**äº¤ä»˜ç‰©**:
- `analysis/portfolio_niching_analysis.py`
- åˆ†æå ±å‘Šæ¨¡æ¿
- è¦–è¦ºåŒ–åœ–è¡¨

**é©—æ”¶æ¨™æº–**:
- [ ] åˆ†æå…¨é¢
- [ ] çµ±è¨ˆæ–¹æ³•æ­£ç¢º
- [ ] å ±å‘Šæ¸…æ™°

#### 4.3 æ–‡æª”èˆ‡ç¯„ä¾‹ (Week 1)

**ä»»å‹™æ¸…å–®**:
- [ ] ä½¿ç”¨æ‰‹å†Š
  - [ ] å¿«é€Ÿé–‹å§‹æŒ‡å—
  - [ ] é…ç½®èªªæ˜
  - [ ] å¸¸è¦‹å•é¡Œ
- [ ] å¯¦é©—é‡ç¾æŒ‡å—
  - [ ] ç’°å¢ƒè¨­ç½®
  - [ ] æ•¸æ“šæº–å‚™
  - [ ] åŸ·è¡Œæ­¥é©Ÿ
- [ ] API åƒè€ƒæ–‡æª”
- [ ] è¨­è¨ˆæ±ºç­–æ–‡æª”

**äº¤ä»˜ç‰©**:
- `docs/user_guide.md`
- `docs/experiment_reproduction.md`
- `docs/api_reference.md`
- `docs/design_decisions.md`

**é©—æ”¶æ¨™æº–**:
- [ ] æ–‡æª”å®Œæ•´
- [ ] ç¯„ä¾‹å¯åŸ·è¡Œ
- [ ] æ˜“æ–¼ç†è§£

#### 4.4 Code Review & Merge

---

## è»Ÿé«”å·¥ç¨‹æº–å‰‡

### ç·¨ç¢¼è¦ç¯„

#### Python Style Guide
- éµå¾ª PEP 8
- ä½¿ç”¨ Black é€²è¡Œæ ¼å¼åŒ–
- ä½¿ç”¨ pylint/flake8 é€²è¡Œéœæ…‹æª¢æŸ¥
- Type hints for all public APIs

#### å‘½åè¦ç¯„
- é¡åˆ¥: `PascalCase`
- å‡½æ•¸/æ–¹æ³•: `snake_case`
- å¸¸æ•¸: `UPPER_SNAKE_CASE`
- ç§æœ‰æˆå“¡: `_leading_underscore`

#### æ–‡æª”è¦ç¯„
- æ‰€æœ‰ public API å¿…é ˆæœ‰ docstring
- ä½¿ç”¨ Google style docstring
- åŒ…å«åƒæ•¸ã€è¿”å›å€¼ã€ç•°å¸¸èªªæ˜
- æä¾›ä½¿ç”¨ç¯„ä¾‹

### ç‰ˆæœ¬æ§åˆ¶

#### Git Workflow
```
master (ç©©å®šç‰ˆæœ¬)
  â”œâ”€â”€ feature/portfolio-evaluation
  â”œâ”€â”€ feature/tree-similarity
  â”œâ”€â”€ feature/niching-strategy
  â””â”€â”€ feature/integrated-experiments
```

#### Commit Message è¦ç¯„
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bug ä¿®å¾©
- `docs`: æ–‡æª”æ›´æ–°
- `test`: æ¸¬è©¦ç›¸é—œ
- `refactor`: é‡æ§‹
- `perf`: æ€§èƒ½å„ªåŒ–

**ç¯„ä¾‹**:
```
feat(portfolio): implement event-driven rebalancing

- Add EventDrivenRebalancer class
- Track capital allocation per stock
- Handle buy/sell events independently

Closes #123
```

#### Branch ç®¡ç†
- æ¯å€‹ Phase ä¸€å€‹ feature branch
- å®šæœŸå¾ master rebase
- Merge å‰å¿…é ˆé€šé CI/CD
- ä½¿ç”¨ Pull Request é€²è¡Œ code review

### æ¸¬è©¦ç­–ç•¥

#### æ¸¬è©¦é‡‘å­—å¡”

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   E2E Tests â”‚  (10%)
        â”‚   æ•´åˆæ¸¬è©¦   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚             â”‚
        â”‚ Integration â”‚  (30%)
        â”‚    Tests    â”‚
        â”‚             â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚             â”‚
        â”‚    Unit     â”‚  (60%)
        â”‚    Tests    â”‚
        â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å–®å…ƒæ¸¬è©¦ (Unit Tests)
- è¦†è“‹ç‡ç›®æ¨™: > 85%
- ä½¿ç”¨ pytest
- Mock å¤–éƒ¨ä¾è³´
- æ¸¬è©¦é‚Šç•Œæ¢ä»¶

**ç¯„ä¾‹**:
```python
# tests/backtesting/test_portfolio_engine.py
def test_event_driven_rebalancing():
    """æ¸¬è©¦äº‹ä»¶é©…å‹•å†å¹³è¡¡é‚è¼¯"""
    engine = PortfolioBacktestingEngine(...)
    # Test buy event
    # Test sell event
    # Verify capital allocation
```

#### æ•´åˆæ¸¬è©¦ (Integration Tests)
- æ¸¬è©¦æ¨¡çµ„é–“äº’å‹•
- ä½¿ç”¨çœŸå¯¦æ•¸æ“šçš„å°æ¨£æœ¬
- é©—è­‰ç«¯åˆ°ç«¯æµç¨‹

**ç¯„ä¾‹**:
```python
# tests/integration/test_portfolio_evolution.py
def test_portfolio_evolution_with_niching():
    """æ¸¬è©¦çµ„åˆè©•ä¼° + niching çš„å®Œæ•´æµç¨‹"""
    # Setup evolution engine
    # Run evolution
    # Verify results
```

#### ç«¯åˆ°ç«¯æ¸¬è©¦ (E2E Tests)
- å®Œæ•´å¯¦é©—æµç¨‹
- ä½¿ç”¨çœŸå¯¦é…ç½®
- é©—è­‰æœ€çµ‚çµæœ

#### æ€§èƒ½æ¸¬è©¦
- å›æ¸¬é€Ÿåº¦åŸºæº–
- è¨˜æ†¶é«”ä½¿ç”¨ç›£æ§
- ç›¸ä¼¼åº¦è¨ˆç®—æ•ˆèƒ½
- èšé¡æ¼”ç®—æ³•æ•ˆèƒ½

#### å›æ­¸æ¸¬è©¦
- ç¢ºä¿æ–°åŠŸèƒ½ä¸ç ´å£ç¾æœ‰åŠŸèƒ½
- è‡ªå‹•åŒ–åŸ·è¡Œ
- æ¯æ¬¡ merge å‰å¿…é ˆé€šé

### æŒçºŒæ•´åˆ/æŒçºŒéƒ¨ç½² (CI/CD)

#### GitHub Actions Workflow

```yaml
name: CI/CD Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run linter
        run: pylint gp_quant
      - name: Run tests
        run: pytest --cov=gp_quant
      - name: Upload coverage
        uses: codecov/codecov-action@v2
```

#### æª¢æŸ¥é …ç›®
- [ ] Linting (pylint, flake8)
- [ ] Type checking (mypy)
- [ ] Unit tests
- [ ] Integration tests
- [ ] Code coverage (> 85%)
- [ ] Documentation build

### ä»£ç¢¼å¯©æŸ¥ (Code Review)

#### Review Checklist
- [ ] åŠŸèƒ½æ­£ç¢ºæ€§
- [ ] ä»£ç¢¼å¯è®€æ€§
- [ ] æ¸¬è©¦è¦†è“‹ç‡
- [ ] æ–‡æª”å®Œæ•´æ€§
- [ ] æ€§èƒ½è€ƒé‡
- [ ] å®‰å…¨æ€§æª¢æŸ¥
- [ ] å‘å¾Œå…¼å®¹æ€§

#### Review æµç¨‹
1. é–‹ç™¼è€…æäº¤ Pull Request
2. è‡ªå‹• CI/CD æª¢æŸ¥
3. è‡³å°‘ä¸€ä½ reviewer å¯©æŸ¥
4. ä¿®æ­£ review æ„è¦‹
5. ç²å¾— approval
6. Merge åˆ° master

---

## é¢¨éšªç®¡ç†

### æŠ€è¡“é¢¨éšª

#### é¢¨éšª 1: TED è¨ˆç®—æ•ˆèƒ½ä¸è¶³
**å½±éŸ¿**: é«˜  
**å¯èƒ½æ€§**: ä¸­  
**ç·©è§£ç­–ç•¥**:
- ä½¿ç”¨é«˜æ•ˆæ¼”ç®—æ³•ï¼ˆAPTEDï¼‰
- å¯¦ä½œå¿«å–æ©Ÿåˆ¶
- å¹³è¡ŒåŒ–è¨ˆç®—
- å¦‚æ•ˆèƒ½ä»ä¸è¶³ï¼Œè€ƒæ…®è¿‘ä¼¼æ¼”ç®—æ³•

#### é¢¨éšª 2: Niching å°è‡´æ”¶æ–‚é€Ÿåº¦éæ…¢
**å½±éŸ¿**: ä¸­  
**å¯èƒ½æ€§**: ä¸­  
**ç·©è§£ç­–ç•¥**:
- å¯é…ç½®è·¨ç¾¤äº¤é…æ¯”ä¾‹
- å‹•æ…‹èª¿æ•´ niche æ•¸é‡
- ä¿ç•™ç¾¤å…§ç«¶çˆ­æ©Ÿåˆ¶
- å¯¦é©—é©—è­‰æœ€ä½³åƒæ•¸

#### é¢¨éšª 3: çµ„åˆè©•ä¼°è¨ˆç®—æ™‚é–“éé•·
**å½±éŸ¿**: ä¸­  
**å¯èƒ½æ€§**: ä½  
**ç·©è§£ç­–ç•¥**:
- å¹³è¡ŒåŒ–è©•ä¼°
- å„ªåŒ–å›æ¸¬å¼•æ“
- ä½¿ç”¨å¿«å–
- è€ƒæ…®åˆ†æ•£å¼è¨ˆç®—

### å°ˆæ¡ˆé¢¨éšª

#### é¢¨éšª 4: æ™‚ç¨‹å»¶èª¤
**å½±éŸ¿**: ä¸­  
**å¯èƒ½æ€§**: ä¸­  
**ç·©è§£ç­–ç•¥**:
- ä¿å®ˆä¼°è¨ˆæ™‚ç¨‹
- å®šæœŸæª¢æŸ¥é€²åº¦
- å„ªå…ˆå¯¦ä½œæ ¸å¿ƒåŠŸèƒ½
- å¯é¸åŠŸèƒ½å¯å»¶å¾Œ

#### é¢¨éšª 5: æ•´åˆè¡çª
**å½±éŸ¿**: ä½  
**å¯èƒ½æ€§**: ä½  
**ç·©è§£ç­–ç•¥**:
- æ¨¡çµ„åŒ–è¨­è¨ˆ
- æ¸…æ™°çš„ä»‹é¢å®šç¾©
- å®šæœŸ rebase
- å……åˆ†çš„æ•´åˆæ¸¬è©¦

### ç ”ç©¶é¢¨éšª

#### é¢¨éšª 6: Niching æ•ˆæœä¸é¡¯è‘—
**å½±éŸ¿**: é«˜  
**å¯èƒ½æ€§**: ä¸­  
**ç·©è§£ç­–ç•¥**:
- å¤šç¨® niching ç­–ç•¥å¯¦é©—
- åƒæ•¸èª¿æ•´
- èˆ‡æ–‡ç»æ¯”è¼ƒ
- è¨˜éŒ„è² é¢çµæœ

#### é¢¨éšª 7: çµ„åˆç­–ç•¥è¡¨ç¾ä¸å¦‚å–®è‚¡ç¥¨
**å½±éŸ¿**: é«˜  
**å¯èƒ½æ€§**: ä½  
**ç·©è§£ç­–ç•¥**:
- ç†è«–åˆ†æ
- å¤šçµ„å¯¦é©—é©—è­‰
- èª¿æ•´è©•ä¼°æŒ‡æ¨™
- åˆ†æå¤±æ•—åŸå› 

---

## æœªä¾†æ“´å±•

### çŸ­æœŸæ“´å±• (3-6 å€‹æœˆ)

#### 1. é€²éšå†å¹³è¡¡ç­–ç•¥
- å‹•æ…‹æ¬Šé‡åˆ†é…
- åŸºæ–¼æ³¢å‹•ç‡çš„æ¬Šé‡èª¿æ•´
- é¢¨éšªå¹³åƒ¹ (Risk Parity)

#### 2. å¤šç¨® Niching æ–¹æ³•
- Crowding distance (NSGA-II)
- Speciation
- Island model

#### 3. å¤šç›®æ¨™å„ªåŒ–
- Pareto front
- æ”¶ç›Š vs é¢¨éšª
- æ”¶ç›Š vs è¤‡é›œåº¦

### ä¸­æœŸæ“´å±• (6-12 å€‹æœˆ)

#### 4. æ›´å¤šè³‡ç”¢é¡åˆ¥
- æœŸè²¨
- é¸æ“‡æ¬Š
- åŠ å¯†è²¨å¹£

#### 5. æ©Ÿå™¨å­¸ç¿’æ•´åˆ
- ä½¿ç”¨ ML é æ¸¬æœ€ä½³ niche æ•¸é‡
- è‡ªé©æ‡‰åƒæ•¸èª¿æ•´
- ç‰¹å¾µå·¥ç¨‹

#### 6. åˆ†æ•£å¼è¨ˆç®—
- æ”¯æ´å¤šæ©Ÿå™¨å¹³è¡Œè¨ˆç®—
- GPU åŠ é€Ÿ
- é›²ç«¯éƒ¨ç½²

### é•·æœŸæ“´å±• (1-2 å¹´)

#### 7. è‡ªå‹•åŒ–äº¤æ˜“ç³»çµ±
- å¯¦æ™‚æ•¸æ“šæ¥å…¥
- è‡ªå‹•ä¸‹å–®
- é¢¨éšªç®¡ç†

#### 8. å¯è§£é‡‹æ€§åˆ†æ
- ç­–ç•¥è§£é‡‹å·¥å…·
- æ±ºç­–æ¨¹è¦–è¦ºåŒ–
- ç‰¹å¾µé‡è¦æ€§åˆ†æ

#### 9. å•†æ¥­åŒ–æ‡‰ç”¨
- Web ä»‹é¢
- API æœå‹™
- è¨‚é–±æ¨¡å¼

---

## æ™‚ç¨‹è¦åŠƒ

### Gantt Chart

```
Week 1-2:   Phase 1 - Portfolio Evaluation
            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

Week 3-4:   Phase 2 - Tree Similarity
                        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

Week 5-6:   Phase 3 - Niching Strategy
                                    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

Week 7:     Phase 4 - Integration & Experiments
                                                â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

Week 8:     Buffer & Documentation
                                                        â–ˆâ–ˆâ–ˆâ–ˆ
```

### é‡Œç¨‹ç¢‘ (Milestones)

| é‡Œç¨‹ç¢‘ | æ—¥æœŸ | äº¤ä»˜ç‰© |
|--------|------|--------|
| M1: Portfolio Evaluation å®Œæˆ | Week 2 çµæŸ | çµ„åˆå›æ¸¬å¼•æ“ã€æ¸¬è©¦ã€æ–‡æª” |
| M2: Tree Similarity å®Œæˆ | Week 4 çµæŸ | ç›¸ä¼¼åº¦è¨ˆç®—æ¨¡çµ„ã€è¦–è¦ºåŒ– |
| M3: Niching Strategy å®Œæˆ | Week 6 çµæŸ | Niching æ©Ÿåˆ¶ã€é¸æ“‡å™¨ |
| M4: æ•´åˆå®Œæˆ | Week 7 çµæŸ | å®Œæ•´å¯¦é©—ã€åˆ†æå ±å‘Š |
| M5: å°ˆæ¡ˆäº¤ä»˜ | Week 8 çµæŸ | å®Œæ•´æ–‡æª”ã€ä½¿ç”¨æŒ‡å— |

### æ¯é€±æª¢æŸ¥é»

**æ¯é€±äº”**:
- é€²åº¦å›é¡§
- å•é¡Œè¨è«–
- ä¸‹é€±è¨ˆç•«
- é¢¨éšªè©•ä¼°

**æª¢æŸ¥æ¸…å–®**:
- [ ] æœ¬é€±ä»»å‹™å®Œæˆåº¦
- [ ] æ¸¬è©¦é€šéç‡
- [ ] ä»£ç¢¼å¯©æŸ¥ç‹€æ…‹
- [ ] æ–‡æª”æ›´æ–°ç‹€æ…‹
- [ ] é‡åˆ°çš„å•é¡Œ
- [ ] éœ€è¦çš„æ”¯æ´

---

## é™„éŒ„

### A. åƒè€ƒæ–‡ç»

1. **Tree Edit Distance**
   - Zhang, K., & Shasha, D. (1989). Simple fast algorithms for the editing distance between trees and related problems. SIAM journal on computing, 18(6), 1245-1262.
   - Pawlik, M., & Augsten, N. (2015). Efficient computation of the tree edit distance. ACM Transactions on Database Systems (TODS), 40(1), 1-40.

2. **Niching in Genetic Algorithms**
   - Mahfoud, S. W. (1995). Niching methods for genetic algorithms. Urbana, 51(95001), 62-94.
   - Sareni, B., & Krahenbuhl, L. (1998). Fitness sharing and niching methods revisited. IEEE transactions on Evolutionary Computation, 2(3), 97-106.

3. **Portfolio Optimization**
   - Markowitz, H. (1952). Portfolio selection. The journal of finance, 7(1), 77-91.

### B. å·¥å…·èˆ‡å¥—ä»¶

#### å¿…è¦å¥—ä»¶
- `deap`: GP æ¡†æ¶
- `numpy`, `pandas`: æ•¸æ“šè™•ç†
- `matplotlib`, `seaborn`: è¦–è¦ºåŒ–
- `pytest`: æ¸¬è©¦æ¡†æ¶
- `scikit-learn`: èšé¡æ¼”ç®—æ³•

#### å¯é¸å¥—ä»¶
- `zss`: Tree edit distance å¯¦ä½œ
- `apted`: Advanced tree edit distance
- `networkx`: åœ–å½¢åˆ†æ
- `plotly`: äº’å‹•å¼è¦–è¦ºåŒ–

### C. é…ç½®æª”ç¯„ä¾‹

```yaml
# config/portfolio_niching.yaml

# Portfolio Evaluation
portfolio:
  enabled: true
  tickers:
    - ABX.TO
    - BBD-B.TO
    - RY.TO
    - TRP.TO
  rebalancing:
    method: event_driven  # or daily
    initial_capital: 100000
    equal_weight: true

# Niching Strategy
niching:
  enabled: true
  similarity:
    method: tree_edit_distance
    cache_enabled: true
  clustering:
    algorithm: kmeans  # or hierarchical
    n_clusters: 5  # or auto
  selection:
    cross_niche_ratio: 0.7
    tournament_size: 3
  fitness_sharing:
    enabled: false
    alpha: 1.0
    sigma: 0.1

# Evolution Parameters
evolution:
  population_size: 5000  # æ”¯æ´å¤§è¦æ¨¡ population
  generations: 50
  crossover_prob: 0.8
  mutation_prob: 0.2

# Parallel Execution â­ æ–°å¢
parallel:
  enabled: true
  n_workers: 8  # CPU æ ¸å¿ƒæ•¸
  mode: concurrent  # fitness å’Œ similarity ä¸¦è¡ŒåŸ·è¡Œ
  # mode: sequential  # åºåˆ—åŸ·è¡Œï¼ˆç”¨æ–¼ debugï¼‰
  fitness:
    batch_size: 625  # 5000 / 8 = 625 per worker
  similarity:
    batch_size: 1562500  # 12,497,500 pairs / 8 workers
    progress_bar: true
```

### D. è³‡æ–™å¤¾çµæ§‹

```
gp_paper/
â”œâ”€â”€ gp_quant/
â”‚   â”œâ”€â”€ backtesting/
â”‚   â”‚   â”œâ”€â”€ engine.py
â”‚   â”‚   â”œâ”€â”€ portfolio_engine.py      # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ rebalancing.py           # æ–°å¢
â”‚   â”‚   â””â”€â”€ metrics.py               # æ–°å¢
â”‚   â”œâ”€â”€ similarity/                   # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ tree_edit_distance.py
â”‚   â”‚   â”œâ”€â”€ similarity_matrix.py
â”‚   â”‚   â”œâ”€â”€ parallel_calculator.py   # æ–°å¢ â­
â”‚   â”‚   â”œâ”€â”€ cache.py
â”‚   â”‚   â””â”€â”€ visualizer.py
â”‚   â”œâ”€â”€ niching/                      # æ–°å¢
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ clustering.py
â”‚   â”‚   â”œâ”€â”€ selection.py
â”‚   â”‚   â”œâ”€â”€ fitness_sharing.py
â”‚   â”‚   â””â”€â”€ visualizer.py
â”‚   â”œâ”€â”€ parallel/                     # æ–°å¢ â­
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ executor.py
â”‚   â”‚   â”œâ”€â”€ fitness_evaluator.py
â”‚   â”‚   â””â”€â”€ sync.py
â”‚   â””â”€â”€ evolution/
â”‚       â”œâ”€â”€ engine.py                 # ä¿®æ”¹
â”‚       â””â”€â”€ config.py                 # ä¿®æ”¹
â”œâ”€â”€ samples/
â”‚   â”œâ”€â”€ portfolio/                    # æ–°å¢
â”‚   â”‚   â””â”€â”€ sample_portfolio_backtest.py
â”‚   â”œâ”€â”€ similarity/                   # æ–°å¢
â”‚   â”‚   â””â”€â”€ sample_similarity_analysis.py
â”‚   â””â”€â”€ niching/                      # æ–°å¢
â”‚       â””â”€â”€ sample_niching_analysis.py
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ backtesting/
â”‚   â”‚   â”œâ”€â”€ test_portfolio_engine.py # æ–°å¢
â”‚   â”‚   â””â”€â”€ test_rebalancing.py      # æ–°å¢
â”‚   â”œâ”€â”€ similarity/                   # æ–°å¢
â”‚   â”‚   â””â”€â”€ test_tree_edit_distance.py
â”‚   â”œâ”€â”€ niching/                      # æ–°å¢
â”‚   â”‚   â””â”€â”€ test_clustering.py
â”‚   â””â”€â”€ integration/                  # æ–°å¢
â”‚       â””â”€â”€ test_portfolio_niching.py
â”œâ”€â”€ experiments/
â”‚   â””â”€â”€ portfolio_niching_experiments.py  # æ–°å¢
â”œâ”€â”€ analysis/
â”‚   â””â”€â”€ portfolio_niching_analysis.py     # æ–°å¢
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ portfolio_evaluation.md       # æ–°å¢
â”‚   â”œâ”€â”€ tree_similarity.md            # æ–°å¢
â”‚   â”œâ”€â”€ niching_strategy.md           # æ–°å¢
â”‚   â”œâ”€â”€ user_guide.md                 # æ–°å¢
â”‚   â””â”€â”€ api_reference.md              # æ–°å¢
â””â”€â”€ config/
    â””â”€â”€ portfolio_niching.yaml        # æ–°å¢
```

---

## ä¸¦è¡ŒåŒ–ç­–ç•¥èˆ‡æ•ˆèƒ½åˆ†æ

### ä¸¦è¡ŒåŒ–è¨­è¨ˆåŸå‰‡

#### 1. å®Œå…¨è¨ˆç®—ï¼Œç„¡æ¡æ¨£

**è¨­è¨ˆæ±ºç­–**: ä¸ä½¿ç”¨æ™ºèƒ½æ¡æ¨£ï¼Œå°æ‰€æœ‰å€‹é«”é€²è¡Œå®Œæ•´è¨ˆç®—

**ç†ç”±**:
- ç¢ºä¿çµæœçš„æº–ç¢ºæ€§å’Œå¯é‡ç¾æ€§
- é¿å…æ¡æ¨£å¸¶ä¾†çš„åå·®
- é©åˆå­¸è¡“ç ”ç©¶çš„åš´è¬¹æ€§è¦æ±‚

#### 2. å¤šå±¤æ¬¡ä¸¦è¡ŒåŒ–

**Level 1: Fitness Evaluation ä¸¦è¡ŒåŒ–**
```python
# å°‡ population åˆ†æˆ 8 æ‰¹ï¼Œæ¯å€‹ worker è™•ç†ä¸€æ‰¹
batch_size = population_size // n_workers
for worker_id in range(n_workers):
    batch = population[worker_id * batch_size : (worker_id + 1) * batch_size]
    worker.evaluate_batch(batch)
```

**Level 2: Tree Similarity ä¸¦è¡ŒåŒ–**
```python
# å°‡æ‰€æœ‰é…å°åˆ†æˆ 8 æ‰¹
total_pairs = n * (n - 1) // 2
pairs_per_worker = total_pairs // n_workers
for worker_id in range(n_workers):
    pairs = generate_pairs(worker_id, pairs_per_worker)
    worker.calculate_similarity(pairs)
```

**Level 3: Fitness + Similarity ä¸¦è¡ŒåŸ·è¡Œ**
```python
# å…©å€‹ä»»å‹™åŒæ™‚åŸ·è¡Œ
with concurrent.futures.ThreadPoolExecutor(max_workers=2) as executor:
    fitness_future = executor.submit(evaluate_fitness_parallel)
    similarity_future = executor.submit(calculate_similarity_parallel)
    
    fitness_scores = fitness_future.result()
    similarity_matrix = similarity_future.result()
```

### æ•ˆèƒ½åˆ†æ

#### Population = 500

| éšæ®µ | åºåˆ—æ™‚é–“ | ä¸¦è¡Œæ™‚é–“ (8 cores) | åŠ é€Ÿæ¯” |
|------|----------|-------------------|--------|
| Fitness Evaluation | 400s | 55s | 7.3x |
| Tree Similarity | 60s | 8s | 7.5x |
| **ç¸½è¨ˆ (åºåˆ—)** | **460s** | **63s** | **7.3x** |
| **ç¸½è¨ˆ (ä¸¦è¡Œ)** | **460s** | **55s** | **8.4x** |

**èªªæ˜**: 
- åºåˆ—æ¨¡å¼: Fitness â†’ Similarity = 55s + 8s = 63s
- ä¸¦è¡Œæ¨¡å¼: max(Fitness, Similarity) = max(55s, 8s) = 55s

#### Population = 5000

| éšæ®µ | åºåˆ—æ™‚é–“ | ä¸¦è¡Œæ™‚é–“ (8 cores) | åŠ é€Ÿæ¯” |
|------|----------|-------------------|--------|
| Fitness Evaluation | 4000s (1.1h) | 550s (9.2min) | 7.3x |
| Tree Similarity | 6249s (1.7h) | 860s (14.3min) | 7.3x |
| Clustering | 50s | 50s | 1.0x |
| Selection | 10s | 10s | 1.0x |
| **ç¸½è¨ˆ (åºåˆ—)** | **10,309s (2.9h)** | **1,470s (24.5min)** | **7.0x** |
| **ç¸½è¨ˆ (ä¸¦è¡Œ)** | **10,309s (2.9h)** | **920s (15.3min)** | **11.2x** |

**50 Generations**:
- åºåˆ—æ¨¡å¼: 2.9h Ã— 50 = 145 å°æ™‚ â‰ˆ **6.0 å¤©**
- ä¸¦è¡Œæ¨¡å¼ (åºåˆ—åŸ·è¡Œ): 24.5min Ã— 50 = 1,225 åˆ†é˜ â‰ˆ **20.4 å°æ™‚**
- ä¸¦è¡Œæ¨¡å¼ (ä¸¦è¡ŒåŸ·è¡Œ): 15.3min Ã— 50 = 765 åˆ†é˜ â‰ˆ **12.8 å°æ™‚**

**çµè«–**: ç›¸æ¯”åŸå§‹åºåˆ—å¯¦ä½œï¼Œä¸¦è¡ŒåŒ–å¯ç¯€çœ **91.2%** çš„æ™‚é–“ï¼

### å¯¦ä½œè€ƒé‡

#### 1. è¨˜æ†¶é«”ç®¡ç†

**å•é¡Œ**: 8 å€‹ workers åŒæ™‚é‹è¡Œï¼Œè¨˜æ†¶é«”ä½¿ç”¨å¢åŠ 

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# ä½¿ç”¨ shared memory é¿å…æ•¸æ“šè¤‡è£½
from multiprocessing import shared_memory

# å°‡ population æ”¾å…¥ shared memory
shm = shared_memory.SharedMemory(create=True, size=population_size * 1024)
# Workers ç›´æ¥è®€å– shared memoryï¼Œä¸è¤‡è£½æ•¸æ“š
```

**è¨˜æ†¶é«”ä¼°ç®—** (Population = 5000):
- ä¸ä½¿ç”¨ shared memory: ~1.5GB
- ä½¿ç”¨ shared memory: ~800MB

#### 2. è² è¼‰å¹³è¡¡

**å•é¡Œ**: ä¸åŒå€‹é«”çš„å›æ¸¬æ™‚é–“å¯èƒ½ä¸åŒ

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# ä½¿ç”¨å‹•æ…‹ä»»å‹™åˆ†é…
from multiprocessing import Pool

# ä¸é å…ˆåˆ†æ‰¹ï¼Œè®“ Pool å‹•æ…‹åˆ†é…
with Pool(processes=8) as pool:
    fitness_scores = pool.map(evaluate_individual, population)
```

#### 3. é€²åº¦è¿½è¹¤

**å•é¡Œ**: é•·æ™‚é–“è¨ˆç®—éœ€è¦é€²åº¦åé¥‹

**è§£æ±ºæ–¹æ¡ˆ**:
```python
from tqdm import tqdm
from multiprocessing import Manager

# ä½¿ç”¨ shared counter è¿½è¹¤é€²åº¦
manager = Manager()
counter = manager.Value('i', 0)

with tqdm(total=total_tasks) as pbar:
    for result in pool.imap_unordered(task, tasks):
        counter.value += 1
        pbar.update(1)
```

### å¯æ“´å±•æ€§åˆ†æ

#### ä¸åŒ Population Size çš„æ•ˆèƒ½

| Population | åºåˆ—æ™‚é–“ | ä¸¦è¡Œæ™‚é–“ (8 cores) | æ¯ä»£æ™‚é–“ | 50 ä»£ç¸½æ™‚é–“ |
|------------|----------|-------------------|----------|-------------|
| 100 | 2 min | 20 sec | 20 sec | 17 min |
| 500 | 8 min | 1 min | 55 sec | 46 min |
| 1000 | 30 min | 4 min | 3.5 min | 2.9 hours |
| 2000 | 2 hours | 16 min | 13 min | 10.8 hours |
| 5000 | 2.9 hours | 25 min | 15 min | 12.8 hours |
| 10000 | 11.5 hours | 1.6 hours | 1 hour | 50 hours |

**è§€å¯Ÿ**:
- Population < 1000: ä¸¦è¡Œå„ªå‹¢æ˜é¡¯ï¼Œé©åˆå¿«é€Ÿå¯¦é©—
- Population = 5000: æœ€ä½³å¹³è¡¡é»ï¼Œ12.8 å°æ™‚å¯æ¥å—
- Population > 10000: éœ€è¦è€ƒæ…®åˆ†æ•£å¼è¨ˆç®—

#### ä¸åŒæ ¸å¿ƒæ•¸çš„å½±éŸ¿

| æ ¸å¿ƒæ•¸ | Population=5000 æ™‚é–“ | åŠ é€Ÿæ¯” | æ•ˆç‡ |
|--------|---------------------|--------|------|
| 1 (åºåˆ—) | 2.9 hours | 1.0x | 100% |
| 2 | 1.5 hours | 1.9x | 95% |
| 4 | 48 min | 3.6x | 90% |
| 8 | 25 min | 7.0x | 88% |
| 16 | 15 min | 11.6x | 73% |

**å»ºè­°**: 8 æ ¸å¿ƒæ˜¯æœ€ä½³é…ç½®ï¼Œæ•ˆç‡é«˜ä¸”åŠ é€Ÿæ¯”é¡¯è‘—

### é¢¨éšªèˆ‡ç·©è§£

#### é¢¨éšª 1: ä¸¦è¡Œé–‹éŠ·éé«˜

**è¡¨ç¾**: å° population æ™‚ä¸¦è¡Œåè€Œæ›´æ…¢

**ç·©è§£**:
```python
def should_use_parallel(population_size):
    # åªæœ‰ population > 200 æ™‚æ‰ä½¿ç”¨ä¸¦è¡Œ
    return population_size > 200
```

#### é¢¨éšª 2: è¨˜æ†¶é«”ä¸è¶³

**è¡¨ç¾**: å¤§ population æ™‚è¨˜æ†¶é«”æº¢å‡º

**ç·©è§£**:
- ä½¿ç”¨ shared memory
- ç›£æ§è¨˜æ†¶é«”ä½¿ç”¨
- æä¾›é™ç´šåˆ°åºåˆ—æ¨¡å¼çš„é¸é …

#### é¢¨éšª 3: Worker å´©æ½°

**è¡¨ç¾**: æŸå€‹ worker å¤±æ•—å°è‡´æ•´å€‹è¨ˆç®—ä¸­æ–·

**ç·©è§£**:
```python
# ä½¿ç”¨ error_callback è™•ç†éŒ¯èª¤
def error_callback(error):
    logger.error(f"Worker failed: {error}")
    # é‡è©¦æˆ–é™ç´šåˆ°åºåˆ—æ¨¡å¼

pool.apply_async(task, error_callback=error_callback)
```

---

## Phase 2.1: Fitness Function æ”¹é€² (Sharpe Ratio)

### èƒŒæ™¯èˆ‡å‹•æ©Ÿ

**å•é¡Œ**: ç•¶å‰ç³»çµ±ä½¿ç”¨ Excess Return ä½œç‚º fitnessï¼Œæœªè€ƒæ…®é¢¨éšªå› ç´ ï¼Œå¯èƒ½å°è‡´ï¼š
- æ¼”åŒ–å‡ºé«˜å›å ±ä½†é«˜æ³¢å‹•çš„ç­–ç•¥
- éåº¦æ“¬åˆè¨“ç·´æ•¸æ“š
- æ¸¬è©¦æœŸè¡¨ç¾ä¸ç©©å®š

**è§£æ±ºæ–¹æ¡ˆ**: å¼•å…¥ Sharpe Ratio ä½œç‚ºå¯é¸çš„ fitness metric
- é¢¨éšªèª¿æ•´å›å ± = å›å ± / æ³¢å‹•æ€§
- é¼“å‹µæ¼”åŒ–å‡ºæ›´ç©©å¥çš„ç­–ç•¥
- ç¬¦åˆç¾ä»£æŠ•è³‡çµ„åˆç†è«–

**å¯¦ä½œæ–¹æ¡ˆ**: æ–¹æ¡ˆ Bï¼ˆé›™è»Œä¸¦è¡Œï¼‰
- ä¿ç•™ `excess_return` ä½œç‚º baseline
- æ–°å¢ `sharpe_ratio` ä½œç‚ºæ”¹é€²æ–¹æ¡ˆ
- é€šéé…ç½®åƒæ•¸åˆ‡æ›
- é€²è¡Œå°æ¯”å¯¦é©—

### æŠ€è¡“è¦æ ¼

#### 1. Sharpe Ratio è¨ˆç®—

**å…¬å¼**:
```
Sharpe Ratio = (å¹´åŒ–å¹³å‡å›å ± - ç„¡é¢¨éšªåˆ©ç‡) / å¹´åŒ–æ³¢å‹•ç‡
             = (mean(daily_returns) * 252 - rf) / (std(daily_returns) * sqrt(252))
```

**å¯¦ä½œè¦é»**:
- åŸºæ–¼æ¯æ—¥æ¬Šç›Šæ›²ç·šè¨ˆç®—æ—¥å›å ±ç‡
- éæ¿¾ NaN å’Œ Inf å€¼
- è™•ç†é›¶æ³¢å‹•æƒ…æ³
- å¹´åŒ–å‡è¨­ 252 å€‹äº¤æ˜“æ—¥

#### 2. é‚Šç•Œæƒ…æ³è™•ç†

| æƒ…æ³ | è™•ç†æ–¹å¼ | Fitness å€¼ |
|------|---------|-----------|
| ç„¡ä»»ä½•äº¤æ˜“è¨˜éŒ„ | è¿”å›ä¸­æ€§ fitness | 0.0 |
| æ¬Šç›Šæ›²ç·šé•·åº¦ < 2 | ç„¡æ³•è¨ˆç®—å›å ± | 0.0 |
| æ¨™æº–å·® = 0 | é›¶æ³¢å‹•ï¼ˆå®Œå…¨ä¸äº¤æ˜“ï¼‰ | 0.0 |
| Sharpe > 10 æˆ– < -10 | ç•°å¸¸å€¼ | -100000.0 (penalty) |
| NaN æˆ– Inf | æ•¸å€¼éŒ¯èª¤ | -100000.0 (penalty) |

**è¨­è¨ˆåŸå‰‡**:
- ç„¡äº¤æ˜“ç­–ç•¥ä¸æ‡‰ç²å¾—æ‡²ç½°ï¼ˆfitness = 0ï¼‰
- ç•°å¸¸ç­–ç•¥çµ¦äºˆå¤§æ‡²ç½°ï¼ˆfitness = -100000ï¼‰
- ä¿æŒèˆ‡ç¾æœ‰ penalty æ©Ÿåˆ¶ä¸€è‡´

#### 3. ä¿®æ”¹ç¯„åœ

**æª”æ¡ˆ 1**: `gp_quant/backtesting/engine.py`
```python
class BacktestingEngine:
    def evaluate(self, individual, fitness_metric='excess_return'):
        # æ–°å¢ fitness_metric åƒæ•¸
        
    def _calculate_sharpe_ratio(self, signals, data, risk_free_rate=0.0):
        # æ–°å¢æ–¹æ³•ï¼šè¨ˆç®— Sharpe Ratio
        
    def _run_simulation_with_equity_curve(self, signals, data):
        # æ–°å¢æ–¹æ³•ï¼šè¿”å›æ¯æ—¥æ¬Šç›Šæ›²ç·š
```

**æª”æ¡ˆ 2**: `gp_quant/backtesting/portfolio_engine.py`
```python
class PortfolioBacktestingEngine:
    def evaluate(self, individual, fitness_metric='excess_return'):
        # æ”¯æ´ä¸‰ç¨®æ¨¡å¼ï¼š
        # - 'excess_return': sum of excess returns
        # - 'sharpe_ratio': portfolio-level Sharpe
        # - 'avg_sharpe': average of individual Sharpes
```

**æª”æ¡ˆ 3**: `run_portfolio_experiment.py`
```python
CONFIG = {
    'fitness_metric': 'sharpe_ratio',  # æ–°å¢é…ç½®
    'risk_free_rate': 0.0,             # æ–°å¢é…ç½®
}
```

#### 4. é…ç½®åƒæ•¸

| åƒæ•¸ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| `fitness_metric` | str | 'excess_return' | 'excess_return', 'sharpe_ratio', 'avg_sharpe' |
| `risk_free_rate` | float | 0.0 | å¹´åŒ–ç„¡é¢¨éšªåˆ©ç‡ |
| `min_trades_for_sharpe` | int | 2 | è¨ˆç®— Sharpe æ‰€éœ€æœ€å°‘äº¤æ˜“æ•¸ |

### å¯¦é©—è¨­è¨ˆ

#### Baseline Experiment (å·²å®Œæˆ)
- Fitness: Excess Return
- Population: 5000
- Generations: 50
- çµæœ: è¨“ç·´æœŸ Sharpe = 3.48, æ¸¬è©¦æœŸ Sharpe = 1.66

#### Proposed Experiment (å¾…åŸ·è¡Œ)
- Fitness: Sharpe Ratio
- Population: 5000
- Generations: 50
- é æœŸ: æ¸¬è©¦æœŸ Sharpe æ›´ç©©å®šï¼Œéåº¦æ“¬åˆæ¸›å°‘

#### æ¯”è¼ƒæŒ‡æ¨™
1. **æ¨£æœ¬å…§è¡¨ç¾**
   - Excess Return
   - Sharpe Ratio
   - Max Drawdown

2. **æ¨£æœ¬å¤–è¡¨ç¾** (é—œéµ)
   - Excess Return
   - Sharpe Ratio
   - Max Drawdown
   - Win Rate

3. **æ³›åŒ–èƒ½åŠ›**
   - æ¨£æœ¬å…§å¤– Sharpe å·®ç•°
   - æ¨£æœ¬å…§å¤– Excess Return å·®ç•°

### é æœŸæˆæœ

1. **æ›´ç©©å¥çš„ç­–ç•¥**
   - æ¸¬è©¦æœŸ Sharpe Ratio æ›´é«˜
   - æ³¢å‹•æ€§æ›´ä½
   - å›æ’¤æ›´å°

2. **æ›´å¥½çš„æ³›åŒ–**
   - æ¨£æœ¬å…§å¤–è¡¨ç¾å·®è·ç¸®å°
   - æ¸›å°‘éåº¦æ“¬åˆ

3. **å­¸è¡“è²¢ç»**
   - æ”¹é€²åŸè«–æ–‡æ–¹æ³•
   - æä¾›å°æ¯”å¯¦é©—æ•¸æ“š
   - é©—è­‰é¢¨éšªèª¿æ•´ fitness çš„æ•ˆæœ

### æ™‚ç¨‹

- **å¯¦ä½œ**: 2 å°æ™‚
- **æ¸¬è©¦**: 1 å°æ™‚
- **å¯¦é©—é‹è¡Œ**: 12-15 å°æ™‚
- **åˆ†æ**: 2 å°æ™‚
- **ç¸½è¨ˆ**: 1 å¤©

### é¢¨éšªèˆ‡ç·©è§£

| é¢¨éšª | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|------|---------|
| Sharpe è¨ˆç®—éŒ¯èª¤ | é«˜ | å–®å…ƒæ¸¬è©¦é©—è­‰ |
| æ¼”åŒ–é€Ÿåº¦è®Šæ…¢ | ä¸­ | æ€§èƒ½æ¸¬è©¦ï¼Œå„ªåŒ–è¨ˆç®— |
| çµæœä¸å¦‚é æœŸ | ä½ | ä¿ç•™ baselineï¼Œå¯å›é€€ |
| é‚Šç•Œæƒ…æ³æœªè™•ç† | ä¸­ | è©³ç´°çš„é‚Šç•Œæ¸¬è©¦ |

---

## Phase 2.1.5: Early Stopping æ©Ÿåˆ¶

### èƒŒæ™¯èˆ‡å‹•æ©Ÿ

**å•é¡Œ**: ç•¶å‰æ¼”åŒ–åªæœ‰å›ºå®šä»£æ•¸çµ‚æ­¢æ¢ä»¶ï¼ˆ50 ä»£ï¼‰ï¼Œå¯èƒ½å°è‡´ï¼š
- æ¼”åŒ–å·²æ”¶æ–‚ä½†ä»ç¹¼çºŒé‹è¡Œï¼Œæµªè²»è¨ˆç®—è³‡æº
- ç„¡æ³•æ ¹æ“šæ”¶æ–‚æƒ…æ³å‹•æ…‹èª¿æ•´æ¼”åŒ–æ™‚é–“

**è§£æ±ºæ–¹æ¡ˆ**: æ–°å¢æ—©åœï¼ˆEarly Stoppingï¼‰æ©Ÿåˆ¶
- ç•¶é€£çºŒ N ä»£æœ€ä½³ fitness ç„¡é¡¯è‘—é€²æ­¥æ™‚ï¼Œæå‰çµ‚æ­¢æ¼”åŒ–
- N å¯é…ç½®ï¼ˆpatience åƒæ•¸ï¼‰
- å¯è¨­ç½®æœ€å°æ”¹é€²é–¾å€¼ï¼ˆmin_delta åƒæ•¸ï¼‰

**å¯¦ä½œæ–¹æ¡ˆ**: æ–¹æ¡ˆ A + Cï¼ˆæ··åˆï¼‰
- å‰µå»ºç¨ç«‹çš„ `EarlyStopping` é¡ï¼ˆæ¨¡çµ„åŒ–ï¼‰
- åœ¨ä¸»æ¼”åŒ–å¾ªç’°ä¸­èª¿ç”¨ï¼ˆç°¡å–®ç›´æ¥ï¼‰
- é…ç½®åƒæ•¸åŒ–ï¼Œé»˜èªå•Ÿç”¨

### æŠ€è¡“è¦æ ¼

#### 1. EarlyStopping é¡

**æ–‡ä»¶**: `gp_quant/evolution/early_stopping.py`

**æ ¸å¿ƒæ–¹æ³•**:
```python
class EarlyStopping:
    def __init__(self, patience=10, min_delta=0.0, mode='max'):
        # patience: é€£çºŒç„¡é€²æ­¥çš„ä»£æ•¸
        # min_delta: æœ€å°æ”¹é€²é–¾å€¼
        # mode: 'max' (fitness è¶Šå¤§è¶Šå¥½) æˆ– 'min'
    
    def step(self, current_fitness) -> bool:
        # è¿”å› True è¡¨ç¤ºæ‡‰è©²åœæ­¢
    
    def get_status() -> Dict:
        # è¿”å›ç•¶å‰ç‹€æ…‹
    
    def reset():
        # é‡ç½®ç‹€æ…‹
```

**é‚è¼¯**:
1. è¨˜éŒ„æ­·å²æœ€ä½³ fitness
2. æ¯ä»£è¨ˆç®—æ”¹é€²é‡ = current_fitness - best_fitness
3. å¦‚æœæ”¹é€²é‡ > min_deltaï¼Œé‡ç½®è¨ˆæ•¸å™¨
4. å¦å‰‡è¨ˆæ•¸å™¨ +1
5. ç•¶è¨ˆæ•¸å™¨ >= patience æ™‚ï¼Œè§¸ç™¼æ—©åœ

#### 2. é…ç½®åƒæ•¸

| åƒæ•¸ | é¡å‹ | é è¨­å€¼ | èªªæ˜ |
|------|------|--------|------|
| `early_stopping_enabled` | bool | True | æ˜¯å¦å•Ÿç”¨æ—©åœ |
| `early_stopping_patience` | int | 10 | é€£çºŒç„¡é€²æ­¥çš„ä»£æ•¸ |
| `early_stopping_min_delta` | float | 0.001 | æœ€å°æ”¹é€²é–¾å€¼ |

**æ ¹æ“š Fitness Metric èª¿æ•´**:
- **sharpe_ratio**: min_delta = 0.001 - 0.01ï¼ˆSharpe ç¯„åœ -3 åˆ° 5ï¼‰
- **excess_return**: min_delta = 100 - 1000ï¼ˆå›å ±ç¯„åœå¹¾åƒåˆ°å¹¾è¬ï¼‰

#### 3. æ•´åˆåˆ°æ¼”åŒ–å¾ªç’°

**ä¿®æ”¹**: `run_portfolio_experiment.py`

```python
# åˆå§‹åŒ–æ—©åœ
if CONFIG['early_stopping_enabled']:
    early_stopping = EarlyStopping(
        patience=CONFIG['early_stopping_patience'],
        min_delta=CONFIG['early_stopping_min_delta'],
        mode='max'
    )

# æ¼”åŒ–å¾ªç’°
for gen in range(CONFIG['generations']):
    # ... è©•ä¼°ã€é¸æ“‡ã€è®Šç•° ...
    
    # æ—©åœæª¢æŸ¥
    if early_stopping is not None:
        current_best = hof[0].fitness.values[0]
        
        if early_stopping.step(current_best):
            print(f"â¹ï¸  æ—©åœè§¸ç™¼ï¼")
            print(f"   é€£çºŒ {early_stopping.counter} ä»£ç„¡é¡¯è‘—é€²æ­¥")
            # å„²å­˜æœ€çµ‚æ—ç¾¤
            # è¨˜éŒ„æ—©åœè³‡è¨Š
            break
```

#### 4. è¼¸å‡ºèˆ‡è¨˜éŒ„

**é…ç½®é¡¯ç¤º**:
```
æ—©åœæ©Ÿåˆ¶: å•Ÿç”¨ï¼ˆpatience=10, min_delta=0.001ï¼‰
```

**æ¼”åŒ–éç¨‹**:
```
â¸ï¸  æ—©åœç‹€æ…‹: 3/10 ä»£ç„¡é€²æ­¥
```

**è§¸ç™¼æ™‚**:
```
â¹ï¸  æ—©åœè§¸ç™¼ï¼
   é€£çºŒ 10 ä»£ç„¡é¡¯è‘—é€²æ­¥
   æœ€ä½³ fitness: 1.5234
   æœ€çµ‚ generation: 35/50
```

**æœ€çµ‚çµæœ**:
```
ğŸ“Š ç¸½ä¸–ä»£æ•¸: 35/50
â¹ï¸  æ—©åœ: æ˜¯ï¼ˆç¬¬ 35 ä»£è§¸ç™¼ï¼‰
   åŸå› : é€£çºŒ 10 ä»£ç„¡é¡¯è‘—é€²æ­¥ï¼ˆmin_delta=0.001ï¼‰
   æœ€ä½³ fitness: 1.5234
```

**JSON æ—¥èªŒ**:
```json
{
  "actual_generations": 35,
  "early_stopping": {
    "enabled": true,
    "triggered": true,
    "status": {
      "counter": 10,
      "best_fitness": 1.5234,
      "should_stop": true,
      "generation": 35,
      "patience": 10,
      "min_delta": 0.001
    }
  }
}
```

### æ¸¬è©¦é©—è­‰

**æ¸¬è©¦æ–‡ä»¶**: `test_early_stopping_simple.py`

**æ¸¬è©¦é …ç›®**:
- âœ… åŸºæœ¬æ—©åœåŠŸèƒ½
- âœ… å¸¶é–¾å€¼çš„æ—©åœ
- âœ… æœ‰é€²æ­¥æ™‚é‡ç½®è¨ˆæ•¸å™¨
- âœ… mode='min' çš„æƒ…æ³
- âœ… ç²å–ç‹€æ…‹
- âœ… é‡ç½®åŠŸèƒ½
- âœ… Sharpe Ratio fitness å ´æ™¯
- âœ… Excess Return fitness å ´æ™¯
- âœ… ç„¡æ•ˆè¼¸å…¥è™•ç†

**æ¸¬è©¦çµæœ**: æ‰€æœ‰æ¸¬è©¦é€šé âœ…

### é æœŸæ•ˆæœ

1. **ç¯€çœè¨ˆç®—æ™‚é–“**
   - å¯èƒ½ç¯€çœ 20-50% çš„æ¼”åŒ–æ™‚é–“
   - ç‰¹åˆ¥æ˜¯åœ¨æ¼”åŒ–å·²æ”¶æ–‚çš„æƒ…æ³ä¸‹

2. **é¿å…ç„¡æ„ç¾©çš„æ¼”åŒ–**
   - ç•¶æ—ç¾¤å·²æ”¶æ–‚æ™‚åŠæ™‚åœæ­¢
   - æ¸›å°‘éåº¦æ“¬åˆé¢¨éšª

3. **éˆæ´»æ€§**
   - å¯æ ¹æ“šå¯¦é©—éœ€æ±‚èª¿æ•´ patience å’Œ min_delta
   - å¯é¸æ“‡æ€§å•Ÿç”¨/åœç”¨

4. **å‘å¾Œå…¼å®¹**
   - é»˜èªå•Ÿç”¨ï¼Œä½†å¯é…ç½®
   - ä¸å½±éŸ¿ç¾æœ‰å¯¦é©—çµæœçš„å¯é‡ç¾æ€§

### æ™‚ç¨‹

- **å¯¦ä½œ**: 2 å°æ™‚ âœ…
- **æ¸¬è©¦**: 1 å°æ™‚ âœ…
- **æ–‡æª”**: 0.5 å°æ™‚ âœ…
- **ç¸½è¨ˆ**: 3.5 å°æ™‚ âœ…

### é¢¨éšªèˆ‡ç·©è§£

| é¢¨éšª | å½±éŸ¿ | ç·©è§£æªæ–½ | ç‹€æ…‹ |
|------|------|---------|------|
| éæ—©åœæ­¢ | ä¸­ | èª¿æ•´ patience å’Œ min_delta | âœ… å¯é…ç½® |
| èˆ‡ä¸åŒ fitness metric ä¸å…¼å®¹ | ä½ | æ ¹æ“š metric èª¿æ•´ min_delta | âœ… æ–‡æª”èªªæ˜ |
| å½±éŸ¿çµæœå¯é‡ç¾æ€§ | ä½ | è¨˜éŒ„å®Œæ•´æ—©åœè³‡è¨Š | âœ… å·²å¯¦ä½œ |

---

## è®Šæ›´æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è®Šæ›´å…§å®¹ |
|------|------|------|----------|
| 1.0 | 2025-10-09 | Cascade | åˆç‰ˆå®Œæˆ |
| 1.1 | 2025-10-09 | Cascade | æ›´æ–°ç‚ºå®Œå…¨ä¸¦è¡ŒåŒ–æ¶æ§‹ï¼ˆæ–¹æ¡ˆ Fï¼‰ï¼Œæ”¯æ´ Population 5000+ |
| 1.2 | 2025-10-12 | Cascade | æ›´æ–° Phase 1 å®Œæˆç‹€æ…‹ï¼Œæ–°å¢ Norm operator ä»»å‹™ï¼Œèª¿æ•´æ™‚ç¨‹ |
| 1.3 | 2025-10-13 | Cascade | æ–°å¢ Phase 2.1: Fitness Function æ”¹é€²ï¼ˆSharpe Ratioï¼‰ï¼Œæ¡ç”¨æ–¹æ¡ˆ Bï¼ˆé›™è»Œä¸¦è¡Œï¼‰ |
| 1.4 | 2025-10-13 | Cascade | æ–°å¢ Phase 2.1.5: Early Stopping æ©Ÿåˆ¶ï¼Œæ¡ç”¨æ–¹æ¡ˆ A+Cï¼ˆæ··åˆï¼‰ |

---

## å¯©æ‰¹

| è§’è‰² | å§“å | ç°½å | æ—¥æœŸ |
|------|------|------|------|
| å°ˆæ¡ˆè² è²¬äºº | | | |
| æŠ€è¡“è² è²¬äºº | | | |
| ç ”ç©¶æŒ‡å° | | | |

---

**æ–‡ä»¶çµæŸ**
