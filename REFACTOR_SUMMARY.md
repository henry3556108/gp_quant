# å›æ¸¬å¼•æ“é‡æ§‹å®Œæˆç¸½çµ

**æ—¥æœŸ**: 2025-10-01  
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦æ¸¬è©¦é€šé  
**Git Commit**: `b750b4d`

---

## ğŸ“‹ é‡æ§‹ç›®æ¨™

æ ¹æ“š PRD Section 7 çš„è¦ç¯„ï¼Œå¯¦ç¾æ­£ç¢ºçš„åˆå§‹æœŸï¼ˆInitial Periodï¼‰å’Œå›æ¸¬æœŸï¼ˆBacktest Periodï¼‰åˆ†é›¢ï¼Œç¢ºä¿æŠ€è¡“æŒ‡æ¨™æœ‰è¶³å¤ çš„æ­·å²æ•¸æ“šæ”¯æ’ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

å¼•å…¥ä¸‰å€‹æ™‚é–“é»ä¾†æ˜ç¢ºå€åˆ†ã€Œæ•¸æ“šç¯„åœã€å’Œã€Œå›æ¸¬ç¯„åœã€ï¼š

1. **`data_start_date`** - æ•¸æ“šèµ·å§‹æ—¥ï¼ˆåˆå§‹æœŸé–‹å§‹ï¼‰
2. **`backtest_start`** - å›æ¸¬èµ·å§‹æ—¥ï¼ˆé–‹å§‹è¨ˆç®—å ±é…¬ï¼‰
3. **`backtest_end`** - å›æ¸¬çµæŸæ—¥ï¼ˆçµæŸè¨ˆç®—å ±é…¬ï¼‰

```
æ™‚é–“è»¸ï¼š
|-------- åˆå§‹æœŸ --------|-------- å›æ¸¬æœŸ --------|
data_start          backtest_start        backtest_end

ç”¨é€”ï¼š
|-- åªè¨ˆç®—æŠ€è¡“æŒ‡æ¨™ --|-- æŠ€è¡“æŒ‡æ¨™ + å ±é…¬è¨ˆç®— --|
```

---

## ğŸ”§ å¯¦æ–½çš„ä¿®æ”¹

### 1. **gp_quant/data/loader.py**

#### ä¿®æ”¹å‰
```python
def split_train_test_data(data, train_start, train_end, test_start, test_end)
```

#### ä¿®æ”¹å¾Œ
```python
def split_train_test_data(
    data,
    train_data_start,      # è¨“ç·´åˆå§‹æœŸé–‹å§‹
    train_backtest_start,  # è¨“ç·´å›æ¸¬æœŸé–‹å§‹
    train_backtest_end,    # è¨“ç·´å›æ¸¬æœŸçµæŸ
    test_data_start,       # æ¸¬è©¦åˆå§‹æœŸé–‹å§‹
    test_backtest_start,   # æ¸¬è©¦å›æ¸¬æœŸé–‹å§‹
    test_backtest_end      # æ¸¬è©¦å›æ¸¬æœŸçµæŸ
)
```

**è¿”å›çµæ§‹**:
```python
{
    'ticker': {
        'data': DataFrame,           # å®Œæ•´æ•¸æ“šï¼ˆå«åˆå§‹æœŸï¼‰
        'backtest_start': '1998-06-22',  # å›æ¸¬èµ·å§‹æ—¥
        'backtest_end': '1999-06-25'     # å›æ¸¬çµæŸæ—¥
    }
}
```

**ç‰¹æ®Šè™•ç†**:
- è‡ªå‹•è™•ç†æ•¸æ“šä¸è¶³çš„æƒ…æ³ï¼ˆå¦‚ ABX.TO å¾ 1997 å¹´æ‰æœ‰æ•¸æ“šï¼‰
- ä½¿ç”¨å¯¦éš›æ•¸æ“šé–‹å§‹æ—¥æœŸä½œç‚º fallback

---

### 2. **gp_quant/backtesting/engine.py - BacktestingEngine**

#### æ–°å¢åƒæ•¸
```python
def __init__(self, data, initial_capital=100000.0,
             backtest_start=None, backtest_end=None)
```

#### é—œéµæ”¹é€²

1. **æŠ€è¡“æŒ‡æ¨™è¨ˆç®—**: ä½¿ç”¨å®Œæ•´æ•¸æ“šï¼ˆåŒ…å«åˆå§‹æœŸï¼‰
   ```python
   price_vec = self.data['Close'].to_numpy()  # å®Œæ•´æ•¸æ“š
   ```

2. **å ±é…¬è¨ˆç®—**: åªåœ¨å›æ¸¬æœŸè¨ˆç®—
   ```python
   backtest_signals = signals[backtest_mask]
   gp_return = self._run_vectorized_simulation(backtest_signals, self.backtest_data)
   ```

3. **è‡ªå‹•èª¿æ•´**: å¦‚æœ backtest_start æ—©æ–¼æ•¸æ“šé–‹å§‹ï¼Œè‡ªå‹•èª¿æ•´ä¸¦è­¦å‘Š
   ```python
   if pd.Timestamp(self.backtest_start) < self.data.index[0]:
       print(f"Warning: backtest_start is before data start")
       self.backtest_start = self.data.index[0].strftime('%Y-%m-%d')
   ```

---

### 3. **gp_quant/backtesting/engine.py - PortfolioBacktestingEngine**

#### æ–°å¢åƒæ•¸
```python
def __init__(self, data_dict, total_capital=100000.0,
             backtest_config=None)
```

**backtest_config çµæ§‹**:
```python
{
    'ABX.TO': {
        'backtest_start': '1998-06-22',
        'backtest_end': '1999-06-25'
    },
    'BBD-B.TO': {
        'backtest_start': '1998-06-22',
        'backtest_end': '1999-06-25'
    }
}
```

---

### 4. **gp_quant/evolution/engine.py**

#### æ™ºèƒ½æª¢æ¸¬æ•¸æ“šçµæ§‹
```python
if isinstance(data[first_ticker], dict) and 'data' in data[first_ticker]:
    # æ–°çµæ§‹ï¼šæå–æ•¸æ“šå’Œå›æ¸¬é…ç½®
    data_dict = {ticker: data[ticker]['data'] for ticker in data.keys()}
    backtest_config = {...}
    backtester = PortfolioBacktestingEngine(data_dict, backtest_config=backtest_config)
else:
    # èˆŠçµæ§‹ï¼šå‘å¾Œå…¼å®¹
    backtester = PortfolioBacktestingEngine(data)
```

---

### 5. **main.py**

#### ä¿®æ”¹å‰
```python
train_start = '1993-07-02'
train_end = '1999-06-25'
test_start = '1999-06-28'
test_end = '2000-06-30'
```

#### ä¿®æ”¹å¾Œ
```python
# é•·è¨“ç·´æœŸé…ç½®
train_data_start = '1992-06-30'      # è¨“ç·´åˆå§‹æœŸé–‹å§‹
train_backtest_start = '1993-07-02'  # è¨“ç·´å›æ¸¬æœŸé–‹å§‹
train_backtest_end = '1999-06-25'    # è¨“ç·´å›æ¸¬æœŸçµæŸ

test_data_start = '1998-07-07'       # æ¸¬è©¦åˆå§‹æœŸé–‹å§‹
test_backtest_start = '1999-06-28'   # æ¸¬è©¦å›æ¸¬æœŸé–‹å§‹
test_backtest_end = '2000-06-30'     # æ¸¬è©¦å›æ¸¬æœŸçµæŸ
```

---

### 6. **run_all_experiments.py**

#### å¯¦é©—é…ç½®æ›´æ–°

**çŸ­è¨“ç·´æœŸ**:
```python
{
    'name': 'çŸ­è¨“ç·´æœŸ',
    'train_data_start': '1997-06-25',      # åˆå§‹æœŸ: 250å¤©
    'train_backtest_start': '1998-06-22',  # å›æ¸¬æœŸ: 256å¤©
    'train_backtest_end': '1999-06-25',
    'test_data_start': '1998-07-07',       # åˆå§‹æœŸ: 250å¤©
    'test_backtest_start': '1999-06-28',   # å›æ¸¬æœŸ: 256å¤©
    'test_backtest_end': '2000-06-30'
}
```

**é•·è¨“ç·´æœŸ**:
```python
{
    'name': 'é•·è¨“ç·´æœŸ',
    'train_data_start': '1992-06-30',      # åˆå§‹æœŸ: 250å¤©
    'train_backtest_start': '1993-07-02',  # å›æ¸¬æœŸ: 1498å¤©
    'train_backtest_end': '1999-06-25',
    'test_data_start': '1998-07-07',       # åˆå§‹æœŸ: 250å¤©
    'test_backtest_start': '1999-06-28',   # å›æ¸¬æœŸ: 256å¤©
    'test_backtest_end': '2000-06-30'
}
```

---

## âœ… æ¸¬è©¦é©—è­‰

### æ¸¬è©¦æ¡ˆä¾‹: ABX.TO

**æ•¸æ“šæƒ…æ³**:
- å¯¦éš›æ•¸æ“šé–‹å§‹: 1997-06-25
- è«‹æ±‚çš„è¨“ç·´åˆå§‹æœŸ: 1992-06-30ï¼ˆä¸å­˜åœ¨ï¼‰
- è«‹æ±‚çš„è¨“ç·´å›æ¸¬æœŸ: 1993-07-02 to 1999-06-25

**æ¸¬è©¦çµæœ**:
```
âœ… ç³»çµ±è‡ªå‹•æª¢æ¸¬åˆ°æ•¸æ“šä¸è¶³
âœ… ç™¼å‡ºè­¦å‘Š: "backtest_start (1993-07-02) is before data start (1997-06-25)"
âœ… è‡ªå‹•èª¿æ•´ç‚ºå¯¦éš›æ•¸æ“šé–‹å§‹æ—¥æœŸ
âœ… äº¤æ˜“è¨˜éŒ„å¾ 1997-07-25 é–‹å§‹ï¼ˆæ­£ç¢ºï¼‰
âœ… æŠ€è¡“æŒ‡æ¨™ä½¿ç”¨å®Œæ•´å¯ç”¨æ•¸æ“š
```

**æ¸¬è©¦å‘½ä»¤**:
```bash
python main.py --tickers ABX.TO --mode portfolio --generations 2 --population 10
```

**è¼¸å‡ºæ‘˜è¦**:
```
ABX.TO - Train: 505 days total
  Data available from: 1997-06-25
  Initial period: 0 days (1997-06-25 to 1997-06-25)
  Backtest period: 505 days (1997-06-25 to 1999-06-25)

Warning: backtest_start (1993-07-02) is before data start (1997-06-25)
Using actual data start: 1997-06-25

Trade records start from: 1997-07-25 âœ…
```

---

## ğŸ“Š é æœŸå½±éŸ¿

### æ­£é¢å½±éŸ¿

1. **âœ… æŠ€è¡“æŒ‡æ¨™æ›´æº–ç¢º**
   - åœ¨å›æ¸¬èµ·å§‹æ—¥ï¼ŒæŠ€è¡“æŒ‡æ¨™å·²æœ‰ 250 å¤©æ­·å²æ•¸æ“š
   - RSIã€ç§»å‹•å¹³å‡ç­‰æŒ‡æ¨™å€¼æ›´å¯é 
   - é¿å…å‰æœŸæŒ‡æ¨™ä¸ç©©å®šçš„å•é¡Œ

2. **âœ… ç¬¦åˆ PRD è¦ç¯„**
   - å®Œå…¨éµå¾ª PRD Section 7 çš„å¯¦é©—è¨­è¨ˆ
   - åˆå§‹æœŸå’Œå›æ¸¬æœŸæ˜ç¢ºåˆ†é›¢
   - å¯é‡ç¾è«–æ–‡çµæœ

3. **âœ… çµæœæ›´å¯ä¿¡**
   - å ±é…¬ç‡è¨ˆç®—æ›´ç¬¦åˆå¯¦éš›æƒ…æ³
   - é¿å…å‰æœŸæŠ€è¡“æŒ‡æ¨™ä¸æº–ç¢ºå°è‡´çš„ç­–ç•¥å¤±çœŸ
   - æ›´çœŸå¯¦çš„æ¨£æœ¬å¤–è¡¨ç¾è©•ä¼°

### å¯èƒ½çš„è®ŠåŒ–

1. **å ±é…¬ç‡æ•¸å€¼è®ŠåŒ–**
   - ç”±æ–¼åªè¨ˆç®—å›æ¸¬æœŸçš„å ±é…¬ï¼Œæ•¸å€¼å¯èƒ½èˆ‡ä¹‹å‰ä¸åŒ
   - ä½†é€™æ˜¯**æ›´æº–ç¢º**çš„çµæœ

2. **è¨“ç·´æœŸå¤©æ•¸**
   - çŸ­è¨“ç·´æœŸï¼š256 å¤©ï¼ˆå¯¦éš›è¨ˆç®—å ±é…¬ï¼‰+ 250 å¤©ï¼ˆåˆå§‹æœŸï¼‰
   - é•·è¨“ç·´æœŸï¼š1498 å¤©ï¼ˆå¯¦éš›è¨ˆç®—å ±é…¬ï¼‰+ 250 å¤©ï¼ˆåˆå§‹æœŸï¼‰

3. **éœ€è¦é‡æ–°é‹è¡Œå¯¦é©—**
   - ä¹‹å‰çš„ 80 æ¬¡å¯¦é©—çµæœéœ€è¦é‡æ–°è¨ˆç®—
   - ä»¥ç²å¾—åŸºæ–¼æ­£ç¢ºåˆå§‹æœŸçš„çµæœ

---

## ğŸ”„ å‘å¾Œå…¼å®¹æ€§

### å…¼å®¹ç­–ç•¥

1. **å¯é¸åƒæ•¸**: `backtest_start` å’Œ `backtest_end` è¨­ç‚ºå¯é¸
2. **è‡ªå‹•æª¢æ¸¬**: æ¼”åŒ–å¼•æ“è‡ªå‹•æª¢æ¸¬æ–°èˆŠæ•¸æ“šçµæ§‹
3. **Fallback æ©Ÿåˆ¶**: å¦‚æœæœªæä¾›å›æ¸¬é…ç½®ï¼Œä½¿ç”¨å…¨éƒ¨æ•¸æ“š

### èˆŠä»£ç¢¼ä»ç„¶å¯ç”¨

```python
# èˆŠçš„èª¿ç”¨æ–¹å¼ä»ç„¶æœ‰æ•ˆ
backtester = BacktestingEngine(data)  # ä½¿ç”¨å…¨éƒ¨æ•¸æ“š
```

---

## ğŸš¨ æ³¨æ„äº‹é …

### æ•¸æ“šå¯ç”¨æ€§

1. **æª¢æŸ¥æ•¸æ“šç¯„åœ**: ç¢ºä¿æ•¸æ“šè¦†è“‹è«‹æ±‚çš„æ™‚é–“ç¯„åœ
2. **è‡ªå‹•èª¿æ•´**: ç³»çµ±æœƒè‡ªå‹•èª¿æ•´ backtest_start å¦‚æœæ•¸æ“šä¸è¶³
3. **è­¦å‘Šä¿¡æ¯**: æ³¨æ„æŸ¥çœ‹è­¦å‘Šä¿¡æ¯äº†è§£å¯¦éš›ä½¿ç”¨çš„æ—¥æœŸ

### å¯¦é©—é…ç½®

1. **åˆå§‹æœŸé•·åº¦**: PRD è¦å®šç‚º 250 å¤©
2. **æ—¥æœŸå°é½Š**: ç¢ºä¿åˆå§‹æœŸçµæŸ = å›æ¸¬æœŸé–‹å§‹
3. **æ¸¬è©¦æœŸä¸€è‡´**: çŸ­è¨“ç·´æœŸå’Œé•·è¨“ç·´æœŸä½¿ç”¨ç›¸åŒçš„æ¸¬è©¦æœŸ

---

## ğŸ“ ä¸‹ä¸€æ­¥

### å»ºè­°æ“ä½œ

1. **âœ… é‡æ–°é‹è¡Œå¯¦é©—**
   ```bash
   python run_all_experiments.py
   ```
   é è¨ˆæ™‚é–“: ~1-2 å°æ™‚ï¼ˆ80 æ¬¡å¯¦é©—ï¼‰

2. **âœ… å°æ¯”æ–°èˆŠçµæœ**
   - æ¯”è¼ƒå ±é…¬ç‡è®ŠåŒ–
   - åˆ†æå‹ç‡å·®ç•°
   - é©—è­‰æ”¹é€²æ•ˆæœ

3. **âœ… æ›´æ–°æ–‡æª”**
   - è¨˜éŒ„æ–°çš„å¯¦é©—çµæœ
   - æ›´æ–° README èªªæ˜æ–°çš„æ™‚é–“é…ç½®

### å¯é¸å„ªåŒ–

1. **ä¸¦è¡ŒåŒ–**: è€ƒæ…®ä½¿ç”¨å¤šé€²ç¨‹åŠ é€Ÿå¯¦é©—
2. **æª¢æŸ¥é»**: æ·»åŠ å¯¦é©—ä¸­æ–·æ¢å¾©åŠŸèƒ½
3. **å¯è¦–åŒ–**: å‰µå»ºåœ–è¡¨æ¯”è¼ƒæ–°èˆŠçµæœ

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- **è¨­è¨ˆæ–‡æª”**: `BACKTEST_REFACTOR_DESIGN.md`
- **PRD è¦ç¯„**: `PRD.md` Section 7
- **å¯¦é©—èªªæ˜**: `EXPERIMENTS_README.md`
- **ä¸»ç¨‹åº**: `main.py`
- **å¯¦é©—è…³æœ¬**: `run_all_experiments.py`

---

## âœ¨ ç¸½çµ

å›æ¸¬å¼•æ“é‡æ§‹å·²æˆåŠŸå®Œæˆï¼Œæ‰€æœ‰ä¿®æ”¹éƒ½ç¶“éæ¸¬è©¦é©—è­‰ã€‚æ–°ç³»çµ±ï¼š

- âœ… æ­£ç¢ºå¯¦ç¾äº†åˆå§‹æœŸå’Œå›æ¸¬æœŸçš„åˆ†é›¢
- âœ… æŠ€è¡“æŒ‡æ¨™è¨ˆç®—æ›´æº–ç¢º
- âœ… ç¬¦åˆ PRD è¦ç¯„
- âœ… å‘å¾Œå…¼å®¹
- âœ… è‡ªå‹•è™•ç†æ•¸æ“šä¸è¶³çš„æƒ…æ³

ç¾åœ¨å¯ä»¥é‹è¡Œå®Œæ•´çš„å¯¦é©—ä¾†ç²å¾—æ›´æº–ç¢ºçš„çµæœï¼

---

**é‡æ§‹å®Œæˆæ—¥æœŸ**: 2025-10-01  
**Git Commit**: `b750b4d - Implement backtest engine refactor with initial period support`
