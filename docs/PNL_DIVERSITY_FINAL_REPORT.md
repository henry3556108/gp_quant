# PnL Diversity å•é¡Œæœ€çµ‚è¨ºæ–·å ±å‘Š

## ğŸ“‹ åŸ·è¡Œæ—¥æœŸ
2025-11-25

## ğŸ¯ å•é¡Œæè¿°
æ¸¬è©¦è…³æœ¬ç„¡æ³•å¾å¯¦é©—çµæœä¸­çš„å€‹é«”è¨ˆç®—å‡ºæœ‰æ•ˆçš„ PnL æ›²ç·šï¼Œæ‰€æœ‰å€‹é«”çš„ PnL æ›²ç·šéƒ½æ˜¯å…¨é›¶ï¼Œç„¡æ³•è¨ˆç®—å€‹é«”é–“çš„ç›¸é—œæ€§ã€‚

## ğŸ” å®Œæ•´è¨ºæ–·éç¨‹

### éšæ®µ 1: æ•¸æ“šé›†ä¸åŒ¹é…ï¼ˆå·²è§£æ±ºï¼‰
**å•é¡Œ**: æ¸¬è©¦è…³æœ¬ä½¿ç”¨çš„æ˜¯ç¾åœ‹ ETF æ•¸æ“šï¼Œè€Œå¯¦é©—ä½¿ç”¨çš„æ˜¯åŠ æ‹¿å¤§è‚¡ç¥¨æ•¸æ“šã€‚
**è§£æ±º**: å¾å¯¦é©—çµæœç›®éŒ„çš„ `config.json` è®€å–æ­£ç¢ºçš„ `tickers_dir: TSE300_selected`ã€‚

### éšæ®µ 2: æ•¸æ“šç¯„åœå•é¡Œï¼ˆæ ¸å¿ƒå•é¡Œï¼‰
**ç™¼ç¾**: å³ä½¿ä½¿ç”¨æ­£ç¢ºçš„æ•¸æ“šé›†ï¼Œä»ç„¶ç”¢ç”Ÿ 0 transactionsã€‚

#### æ•¸æ“šç¯„åœå°æ¯”ï¼š
```
è¼¸å…¥æ•¸æ“š (data_dict):
  ABX.TO: 1997-06-25 to 1999-06-25 (505 rows) âœ… åŒ…å«å®Œæ•´æ­·å²æ•¸æ“š
  
Engine backtest_data (éæ¿¾å¾Œ):
  ABX.TO: 1998-06-22 to 1999-06-25 (256 rows) âŒ åªæœ‰ backtest period
  
Backtest period:
  1998-06-22 to 1999-06-25
```

#### å•é¡Œæ ¹æºï¼š
`PortfolioBacktestingEngine._prepare_data()` æ–¹æ³•åœ¨ç¬¬ 102 è¡Œï¼š
```python
mask = (df.index >= self.backtest_start) & (df.index <= self.backtest_end)
filtered_df = df[mask].copy()
```

**é€™æœƒéæ¿¾æ‰ backtest period ä¹‹å‰çš„æ‰€æœ‰æ­·å²æ•¸æ“šï¼**

#### ç‚ºä»€éº¼é€™æœƒå°è‡´ 0 transactionsï¼Ÿ

1. **æŠ€è¡“æŒ‡æ¨™éœ€è¦æ­·å²æ•¸æ“š**
   - å€‹é«” 1 çš„è¦å‰‡: `lt(min(ARG1, 104), ROC(ARG1, 73))`
   - `ROC(ARG1, 73)` éœ€è¦ 73 å¤©çš„æ­·å²æ•¸æ“š
   - `min(ARG1, 104)` éœ€è¦ 104 å¤©çš„æ­·å²æ•¸æ“š

2. **æ•¸æ“šä¸è¶³å°è‡´ä¿¡è™Ÿç„¡æ•ˆ**
   - ç•¶ `backtest_data` å¾ 1998-06-22 é–‹å§‹æ™‚
   - ç¬¬ä¸€å¤© (1998-06-22) æ²’æœ‰è¶³å¤ çš„æ­·å²æ•¸æ“šè¨ˆç®— ROC(73) æˆ– min(104)
   - æŠ€è¡“æŒ‡æ¨™è¿”å› NaN æˆ–ç„¡æ•ˆå€¼
   - æ¯”è¼ƒæ“ä½œ `lt()` ç„¡æ³•ç”¢ç”Ÿæœ‰æ•ˆçš„å¸ƒæ—ä¿¡è™Ÿ
   - æ²’æœ‰äº¤æ˜“ä¿¡è™Ÿ â†’ æ²’æœ‰äº¤æ˜“ â†’ PnL ç‚º 0

3. **å¯¦é©—ä¸­ç‚ºä»€éº¼æœ‰äº¤æ˜“ï¼Ÿ**
   - å¯¦é©—ä¸­çš„è©•ä¼°å™¨å¯èƒ½ä½¿ç”¨äº†ä¸åŒçš„æ•¸æ“šæº–å‚™é‚è¼¯
   - æˆ–è€…ä¿ç•™äº†å®Œæ•´çš„æ­·å²æ•¸æ“šç”¨æ–¼æŠ€è¡“æŒ‡æ¨™è¨ˆç®—
   - åªåœ¨ backtest period å…§åŸ·è¡Œäº¤æ˜“

## ğŸš¨ æ ¸å¿ƒçµ„ä»¶è¨­è¨ˆå•é¡Œ

### `PortfolioBacktestingEngine._prepare_data()` çš„è¨­è¨ˆç¼ºé™·ï¼š

**ç•¶å‰è¡Œç‚º**:
- éæ¿¾æ•¸æ“šåªä¿ç•™ `[backtest_start, backtest_end]` ç¯„åœ
- å°è‡´æŠ€è¡“æŒ‡æ¨™ç„¡æ³•æ­£ç¢ºè¨ˆç®—

**æ­£ç¢ºè¡Œç‚ºæ‡‰è©²æ˜¯**:
- ä¿ç•™å®Œæ•´çš„æ­·å²æ•¸æ“šç”¨æ–¼æŠ€è¡“æŒ‡æ¨™è¨ˆç®—
- ä½†åªåœ¨ `[backtest_start, backtest_end]` ç¯„åœå…§åŸ·è¡Œäº¤æ˜“å’Œè¨˜éŒ„ PnL

### ç‚ºä»€éº¼å¯¦é©—ä¸­æ²’æœ‰é€™å€‹å•é¡Œï¼Ÿ

æª¢æŸ¥å¯¦é©—é…ç½®ï¼š
```json
{
  "data": {
    "train_data_start": "1997-06-25",      // æ•¸æ“šé–‹å§‹
    "train_backtest_start": "1998-06-22",  // äº¤æ˜“é–‹å§‹
    "train_backtest_end": "1999-06-25"     // äº¤æ˜“çµæŸ
  }
}
```

å¯¦é©—ä¸­çš„è©•ä¼°å™¨å¯èƒ½ï¼š
1. ä½¿ç”¨ `train_data_start` åˆ° `train_backtest_end` çš„å®Œæ•´æ•¸æ“š
2. ä½†åªåœ¨ `train_backtest_start` åˆ° `train_backtest_end` æœŸé–“åŸ·è¡Œäº¤æ˜“

è€Œ `PortfolioBacktestingEngine` ç›´æ¥éæ¿¾æ‰äº† `train_backtest_start` ä¹‹å‰çš„æ•¸æ“šã€‚

## ğŸ’¡ è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¿®æ”¹ `PortfolioBacktestingEngine` (ä¸å…è¨±)
ä¿®æ”¹ `_prepare_data()` æ–¹æ³•ï¼Œä¿ç•™å®Œæ•´æ­·å²æ•¸æ“šã€‚

**é™åˆ¶**: ç”¨æˆ¶è¦æ±‚ä¸èƒ½ä¿®æ”¹æ ¸å¿ƒçµ„ä»¶ã€‚

### æ–¹æ¡ˆ 2: ä½¿ç”¨å¯¦é©—ä¸­çš„è©•ä¼°å™¨
å¾å¯¦é©—çš„è©•ä¼°å™¨ç²å–æ­£ç¢ºé…ç½®çš„ backtest engineã€‚

**å•é¡Œ**: éœ€è¦é‡æ–°å‰µå»ºæ•´å€‹æ¼”åŒ–å¼•æ“å’Œè©•ä¼°å™¨ã€‚

### æ–¹æ¡ˆ 3: ç›´æ¥å¾ä¿å­˜çš„çµæœè®€å– PnL âœ… (æ¨è–¦)
ä¸é‡æ–°å›æ¸¬ï¼Œç›´æ¥å¾ `best_signals/generation_XXX/` è®€å–ï¼š
- `entry_exit_points.csv` - äº¤æ˜“è¨˜éŒ„
- `backtest_summary.json` - åŒ…å« metrics å’Œ final_value
- å¾äº¤æ˜“è¨˜éŒ„é‡å»º equity curve å’Œ PnL curve

**å„ªé»**:
- ä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒçµ„ä»¶
- ä½¿ç”¨å¯¦é©—æ™‚å¯¦éš›ç”¢ç”Ÿçš„çµæœ
- ä¿è­‰æ•¸æ“šä¸€è‡´æ€§

### æ–¹æ¡ˆ 4: æ‰‹å‹•æä¾›å®Œæ•´æ•¸æ“šç¯„åœ
åœ¨èª¿ç”¨ `PortfolioBacktestingEngine` æ™‚ï¼Œä¸ä½¿ç”¨ `backtest_start`/`backtest_end` åƒæ•¸ï¼Œè®“å®ƒä½¿ç”¨å®Œæ•´æ•¸æ“šç¯„åœï¼Œç„¶å¾Œæ‰‹å‹•éæ¿¾ equity curveã€‚

## ğŸ“Š æŠ€è¡“ç´°ç¯€ç¸½çµ

### æ•¸æ“šæµå°æ¯”ï¼š

**å¯¦é©—ä¸­ (æ­£ç¢º)**:
```
å®Œæ•´æ•¸æ“š (1997-06-25 to 1999-06-25)
    â†“
æŠ€è¡“æŒ‡æ¨™è¨ˆç®— (ä½¿ç”¨å®Œæ•´æ­·å²)
    â†“
äº¤æ˜“ä¿¡è™Ÿç”Ÿæˆ (åœ¨ backtest period å…§)
    â†“
äº¤æ˜“åŸ·è¡Œ (1998-06-22 to 1999-06-25)
    â†“
PnL è¨ˆç®— âœ… æœ‰äº¤æ˜“
```

**æ¸¬è©¦è…³æœ¬ä¸­ (éŒ¯èª¤)**:
```
å®Œæ•´æ•¸æ“š (1997-06-25 to 1999-06-25)
    â†“
PortfolioBacktestingEngine._prepare_data()
    â†“
éæ¿¾æ•¸æ“š (1998-06-22 to 1999-06-25) âŒ ä¸Ÿå¤±æ­·å²æ•¸æ“š
    â†“
æŠ€è¡“æŒ‡æ¨™è¨ˆç®— (æ­·å²æ•¸æ“šä¸è¶³)
    â†“
äº¤æ˜“ä¿¡è™Ÿç”Ÿæˆ (NaN/ç„¡æ•ˆ)
    â†“
äº¤æ˜“åŸ·è¡Œ (0 transactions)
    â†“
PnL è¨ˆç®— âŒ å…¨é›¶
```

## âœ… é©—è­‰

### è­‰æ“š 1: æ•¸æ“šç¯„åœ
```
data_dict: 1997-06-25 to 1999-06-25 (505 rows) âœ…
backtest_data: 1998-06-22 to 1999-06-25 (256 rows) âŒ
å·®è·: 249 days çš„æ­·å²æ•¸æ“šè¢«ä¸Ÿæ£„
```

### è­‰æ“š 2: æŠ€è¡“æŒ‡æ¨™éœ€æ±‚
```
å€‹é«” 1: lt(min(ARG1, 104), ROC(ARG1, 73))
éœ€è¦: max(104, 73) = 104 å¤©æ­·å²æ•¸æ“š
å¯ç”¨: å¾ 1998-06-22 é–‹å§‹ï¼Œç¬¬ä¸€å¤©åªæœ‰ 0 å¤©æ­·å² âŒ
```

### è­‰æ“š 3: å¯¦é©—çµæœ
```
best_signals/generation_000/backtest_summary.json:
  total_transactions: 70 âœ…
  final_value: 110490.37 âœ…
  
æ¸¬è©¦è…³æœ¬:
  transactions: 0 âŒ
  equity: 100000.00 (ä¸è®Š) âŒ
```

## ğŸ“ çµè«–

1. **æ ¹æœ¬åŸå› **: `PortfolioBacktestingEngine._prepare_data()` éæ¿¾æ‰äº†æŠ€è¡“æŒ‡æ¨™æ‰€éœ€çš„æ­·å²æ•¸æ“š

2. **ç‚ºä»€éº¼å¯¦é©—ä¸­æ²’å•é¡Œ**: å¯¦é©—ä½¿ç”¨çš„è©•ä¼°å™¨å¯èƒ½æœ‰ä¸åŒçš„æ•¸æ“šæº–å‚™é‚è¼¯

3. **æ¨è–¦è§£æ±ºæ–¹æ¡ˆ**: ç›´æ¥å¾ä¿å­˜çš„å¯¦é©—çµæœè®€å– PnL æ•¸æ“šï¼Œä¸é‡æ–°å›æ¸¬

4. **é•·æœŸä¿®å¾©**: éœ€è¦ä¿®æ”¹ `PortfolioBacktestingEngine` çš„è¨­è¨ˆï¼Œå€åˆ†ã€Œæ•¸æ“šç¯„åœã€å’Œã€Œäº¤æ˜“ç¯„åœã€

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

å¯¦ç¾æ–¹æ¡ˆ 3ï¼šå‰µå»ºæ–°çš„è…³æœ¬å¾ä¿å­˜çš„äº¤æ˜“è¨˜éŒ„é‡å»º PnL curves ä¸¦è¨ˆç®—ç›¸é—œæ€§ã€‚
