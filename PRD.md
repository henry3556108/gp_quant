

# **論文實作技術規格書：利用遺傳編程生成交易規則**

本文件旨在提供一份完整的技術指南，詳細說明根據 Potvin、Soriano 與 Vallée 在 2004 年發表的論文《Generating trading rules on the stock markets with genetic programming》中所述方法，實作一個利用遺傳編程（Genetic Programming, GP）生成股票交易規則的系統所需的所有必要資訊 1。

## **1\. 系統核心目標**

系統的核心目標是利用遺傳編程自動生成短期的個股交易規則。這些規則被編碼為樹狀結構的程式，其輸出為一個布林值，代表「買入」（True）或「賣出」（False）的信號 1。

## **2\. 交易規則的編碼 (Encoding)**

根據論文 3.1 節，交易規則的樹狀結構具有特定的層次，其中布林函式與運算子位於樹的上層，實數函式位於下層，而關係運算子則作為兩者之間的過渡 1。

### **2.1. 函式集 (Function Set, G)**

函式集是構成交易規則樹內部節點的元素。

| 類別 | 函式 | 說明 |
| :---- | :---- | :---- |
| **布林運算子** | and, or, not | 標準邏輯運算子。 |
| **算術運算子** | \+, \-, /, x | 標準四則運算。 |
| **關係運算子** | \<, \> | 比較兩個實數值，返回布林值。 |
| **布林函式** | if-then-else | 條件判斷函式。 |
| **實數函式** | norm(r1, r2) | 計算兩個實數 r1 和 r2 之間差的絕對值。 |
|  | avg(s, n) | 計算過去 n 天 s 的平均值。s 可為 Price 或 Volume。 |
|  | max(s, n) | 計算過去 n 天 s 的最大值。 |
|  | min(s, n) | 計算過去 n 天 s 的最小值。 |
|  | lag(s, n) | s 在 n 天前的數值。 |
|  | volatility(n) | 計算過去 n 天每日回報的變異數。 |
|  | RSI(n) | 相對強弱指數。 |
|  | ROC(n) | 變動率指標。 |

**RSI 與 ROC 的具體定義** 1

**:**

* ROC(n):  
  ROC(n)=(n天前收盤價當日收盤價​−1)×100  
* RSI(n):  
  RSI(n)=100−(1+RS(n)100​)  
  其中，RS(n)=−∑i∈D−(n)​ri​∑i∈D+(n)​ri​​  
  * D+(n): 過去 n 天中股價上漲的日子集合。  
  * D−(n): 過去 n 天中股價下跌的日子集合。  
  * ri​: 第 i 天的回報率。

### **2.2. 終端集 (Terminal Set, T)**

終端集是構成交易規則樹葉節點的元素。

| 類別 | 終端 | 說明 |
| :---- | :---- | :---- |
| **實數常數** | 隨機數 | 從區間 \`\` 中選取。250 約為一年的交易天數。 |
| **布林常數** | True, False | 標準布林值。 |
| **其他常數** | Price, Volume | 作為 avg, max 等函式的參數，指定要操作的數據類型。 |
| **實數變數** | p | 當日的股價。 |
|  | v | 當日的成交量。 |

## **3\. 交易規則的執行邏輯**

根據論文 3.1 節末段的描述，交易規則的應用方式如下 1：

1. 在**當天結束時**，系統根據當日的市場數據（價格 p、成交量 v 等）執行交易規則樹，得到一個布林信號。  
2. **買入邏輯**：如果當前市場倉位為「空倉」（open），且規則發出「買入」（True）信號，則在**第二天市場開盤時**買入股票，倉位切換為「持倉」（close）。  
3. **賣出邏輯**：如果當前市場倉位為「持倉」（close），且規則發出「賣出」（False）信號，則在**第二天市場開盤時**賣出股票，倉位切換為「空倉」（open）。  
4. **無操作**：在其他所有情況下，維持當前倉位不變。

## **4\. 適應度評估 (Fitness Evaluation)**

根據論文 3.2 節，單個交易規則的「原始適應度」（raw fitness）是其相對於「買入並持有」（buy-and-hold）策略的**超額回報** 1。

**計算方式如下：**

1. **計算買入並持有策略的回報 (Return of Buy-and-Hold)**：  
   * 對於一個從第 0 天到第 t 天的投資期間，其回報為：  
     ReturnB\&H​=Priceday t​−Priceday 0​  
2. **計算 GP 交易規則的回報 (Return of GP Rule)**：  
   * 在同一個投資期間內，將由該交易規則觸發的所有交易所產生的已實現利潤和虧損進行加總。  
3. **計算超額回報 (Excess Return)**：  
   * 超額回報即為兩者的差額：  
     Fitnessraw​=ReturnGP Rule​−ReturnB\&H​

## **5\. 遺傳編程演算法細節**

### **5.1. 初始族群 (Initial Population)**

* 採用 **Full** 和 **Grow** 兩種方法各半的混合模式生成初始族群 1。  
* 由於樹的結構具有特定層次，遞歸生成過程必須遵守以下規則 1：  
  1. 樹的根節點必須從布林函式或運算子中選擇。  
  2. 根節點的子節點可從布林常數、布林函式、布林或關係運算子中選擇。  
  3. 當選擇了關係運算子後，其子節點必須從實數函式或終端中選擇。

### **5.2. 選擇 (Selection)**

論文 3.4 節描述了一種**基於排名的選擇機制** 1：

1. **排序**：首先，根據原始適應度值（即超額回報）對當前族群中的所有個體（程式）進行從最佳（第 1 名）到最差（第 P 名）的排序。  
2. 重新賦值：為排名為 i 的個體賦予一個新的適應度值 fi​，公式如下：  
   fi​=Max−\[(Max−Min)P−1i−1​\]  
   * 論文中設定 Max \= 1.8，Min \= 0.2。  
3. **抽樣**：最後，對這些轉換後的適應度值應用**隨機遍歷抽樣（Stochastic Universal Sampling, SUS）** 來選擇下一代的親代。

### **5.3. 交配 (Crossover)**

* 採用標準的單點交配運算子 1。  
* **特別注意**：由於樹的層次結構，當在第一個親代上選擇了一個交配點後，必須在第二個親代上識別出所有**類型相容**的交配點，並僅從該子集中選擇進行交換。如果沒有相容的點，則重新選擇一對親代 1。

### **5.4. 突變 (Mutation)**

* 在樹中隨機選擇一個點（節點），將該點及其下方的整個子樹移除，並替換為一個新隨機生成的、符合該節點類型約束的子樹 1。

## **6\. 實驗參數設定**

根據論文 4.2 節的表 2，GP 演算法的參數設定如下 1：

| 參數 | 設定值 |
| :---- | :---- |
| **族群大小 (Population size)** | 500 |
| **世代數 (Number of generations)** | 50 |
| **初始化方法 (Initialization method)** | Full 和 Grow 方法各半 |
| **選擇方法 (Selection method)** | 排名 \+ SUS |
| **複製率 (Reproduction rate)** | 0.35 |
| **交配率 (Crossover rate)** | 0.60 |
| **突變率 (Mutation rate)** | 0.05 |
| **交配時選擇內部點的機率** | 0.90 |
| **交配時選擇終端的機率** | 0.10 |
| **初始族群最大深度** | 6 |
| **後續世代最大深度** | 17 |

## **7\. 數據與實驗週期**

注意\! \<以下部分還不用實作\>

根據論文 4.1 節，實驗數據與週期設定如下 1：

* **數據來源**：從 TSE 300 指數中選出的 14 家加拿大公司，涵蓋 14 個不同行業。  
* **數據時間範圍**：1992 年 6 月 30 日至 2000 年 6 月 30 日（共 2003 個交易日）。  
* **數據內容**：每日股價與成交量。

### **7.1. 短訓練週期**

* **訓練初始期**：1997 年 6 月 25 日至 1998 年 6 月 22 日 (250 天)  
* **訓練期**：1998 年 6 月 22 日至 1999 年 6 月 25 日 (256 天)  
* **測試初始期**：1998 年 7 月 07 日至 1999 年 6 月 25 日 (250 天)  
* **測試期**：1999 年 6 月 28 日至 2000 年 6 月 30 日 (256 天)

### **7.2. 長訓練週期**

* **訓練初始期**：1992 年 6 月 30 日至 1993 年 7 月 02 日 (250 天)  
* **訓練期**：1993 年 7 月 02 日至 1999 年 6 月 25 日 (1498 天)  
* **測試初始期**：1998 年 7 月 07 日至 1999 年 6 月 25 日 (250 天)  
* **測試期**：1999 年 6 月 28 日至 2000 年 6 月 30 日 (256 天)

## **8\. 關鍵結論摘要**

實作此系統時，應注意論文的最終發現，這對評估系統性能至關重要：

* **過度擬合問題**：在訓練期表現出的高回報（短週期平均 131.17%）在測試期未能重現，反而出現負回報（短週期平均 \-4.85%），顯示出嚴重的過度擬合現象 1。  
* **核心價值**：論文的結論指出，GP 生成的交易規則**在市場下跌或盤整時通常是有益的**。然而，在市場上漲時，這些規則的表現不如買入並持有策略 1。這意味著系統的價值可能在於風險管理或市場狀態過濾，而非創造絕對回報。

#### **引用的著作**

1. Generating trading rules on the stock markets with genetic programming.pdf